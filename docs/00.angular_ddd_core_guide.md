# Angular DDD æ ¸å¿ƒåº«ä½¿ç”¨æŒ‡å—

## ğŸ“š **æ¦‚è¿°**

æœ¬æŒ‡å—ä»‹ç´¹å¦‚ä½•åœ¨ Angular å°ˆæ¡ˆä¸­ä½¿ç”¨ `@type-ddd/core` å’Œ `rich-domain` åº«ä¾†å¯¦ç¾ Domain-Driven Design (DDD) æ¶æ§‹ã€‚

## ğŸš€ **å®‰è£**

### å®‰è£æ ¸å¿ƒä¾è³´

```bash
# ä½¿ç”¨ yarn
yarn add @type-ddd/core rich-domain

# ä½¿ç”¨ pnpm
pnpm add @type-ddd/core rich-domain
```

### å®‰è£ç‰¹å®šæ¨¡çµ„ï¼ˆå¯é¸ï¼‰

```bash
# å®‰è£ç‰¹å®š DDD æ¨¡çµ„
npm install @type-ddd/email @type-ddd/money @type-ddd/date @type-ddd/password

# å®‰è£é©—è­‰ç›¸é—œ
npm install @type-ddd/cpf @type-ddd/cnpj @type-ddd/username @type-ddd/zip-code
```

## ğŸ—ï¸ **æ ¸å¿ƒæ¦‚å¿µ**

### 1. **Result æ¨¡å¼**
```typescript
import { Result, Ok, Fail } from '@type-ddd/core';

// æˆåŠŸçµæœ
const successResult: Result<string> = Ok('æ“ä½œæˆåŠŸ');

// å¤±æ•—çµæœ
const failureResult: Result<string> = Fail('æ“ä½œå¤±æ•—');

// æª¢æŸ¥çµæœ
if (successResult.isOk()) {
  console.log('æˆåŠŸ:', successResult.value());
} else {
  console.log('å¤±æ•—:', successResult.error());
}
```

### 2. **Value Objectï¼ˆå€¼ç‰©ä»¶ï¼‰**
```typescript
import { ValueObject, Ok, Fail, Result } from '@type-ddd/core';

interface EmailProps {
  value: string;
}

export class Email extends ValueObject<EmailProps> {
  private constructor(props: EmailProps) {
    super(props);
  }

  // éœæ…‹é©—è­‰æ–¹æ³•
  public static isValidProps({ value }: EmailProps): boolean {
    const emailRegex = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return emailRegex.test(value);
  }

  // éœæ…‹å·¥å» æ–¹æ³•
  public static create(value: string): Result<Email> {
    if (!this.isValidProps({ value })) {
      return Fail('ç„¡æ•ˆçš„é›»å­éƒµä»¶æ ¼å¼');
    }
    return Ok(new Email({ value }));
  }

  // æ¥­å‹™é‚è¼¯æ–¹æ³•
  public getDomain(): string {
    return this.props.value.split('@')[1];
  }

  public getLocalPart(): string {
    return this.props.value.split('@')[0];
  }
}
```

### 3. **Entityï¼ˆå¯¦é«”ï¼‰**
```typescript
import { Entity, Ok, Fail, Result, UID } from '@type-ddd/core';

interface UserProps {
  id?: UID;
  email: Email;
  name: string;
  isActive: boolean;
}

export class User extends Entity<UserProps> {
  private constructor(props: UserProps) {
    super(props);
  }

  // éœæ…‹é©—è­‰æ–¹æ³•
  public static isValidProps({ email, name }: UserProps): boolean {
    return email && name && name.trim().length > 0;
  }

  // éœæ…‹å·¥å» æ–¹æ³•
  public static create(props: UserProps): Result<User> {
    if (!this.isValidProps(props)) {
      return Fail('ç„¡æ•ˆçš„ç”¨æˆ¶è³‡æ–™');
    }
    return Ok(new User(props));
  }

  // æ¥­å‹™é‚è¼¯æ–¹æ³•
  public activate(): User {
    this.props.isActive = true;
    return this;
  }

  public deactivate(): User {
    this.props.isActive = false;
    return this;
  }

  public changeName(newName: string): User {
    if (newName.trim().length > 0) {
      this.props.name = newName.trim();
    }
    return this;
  }
}
```

### 4. **Aggregateï¼ˆèšåˆæ ¹ï¼‰**
```typescript
import { Aggregate, Ok, Fail, Result, UID, EventHandler } from '@type-ddd/core';

interface OrderProps {
  id?: UID;
  userId: UID;
  items: OrderItem[];
  status: OrderStatus;
  totalAmount: Money;
}

export class Order extends Aggregate<OrderProps> {
  private constructor(props: OrderProps) {
    super(props);
  }

  // éœæ…‹å·¥å» æ–¹æ³•
  public static create(props: OrderProps): Result<Order> {
    if (!this.isValidProps(props)) {
      return Fail('ç„¡æ•ˆçš„è¨‚å–®è³‡æ–™');
    }
    return Ok(new Order(props));
  }

  // æ¥­å‹™é‚è¼¯æ–¹æ³•
  public addItem(item: OrderItem): Order {
    this.props.items.push(item);
    this.props.totalAmount = this.props.totalAmount.sum(item.price);

    // æ·»åŠ é ˜åŸŸäº‹ä»¶
    this.addEvent(new OrderItemAddedEvent(this.props.id, item));

    return this;
  }

  public confirm(): Order {
    this.props.status = OrderStatus.CONFIRMED;
    this.addEvent(new OrderConfirmedEvent(this.props.id));
    return this;
  }

  public cancel(): Order {
    this.props.status = OrderStatus.CANCELLED;
    this.addEvent(new OrderCancelledEvent(this.props.id));
    return this;
  }
}
```

## ğŸ”„ **é ˜åŸŸäº‹ä»¶è™•ç†**

### 1. **äº‹ä»¶è™•ç†å™¨**
```typescript
import { EventHandler } from '@type-ddd/core';

export class OrderConfirmedEvent extends EventHandler<Order> {
  constructor() {
    super({ eventName: 'ORDER_CONFIRMED' });
  }

  dispatch(order: Order): void {
    // è™•ç†è¨‚å–®ç¢ºèªé‚è¼¯
    console.log(`è¨‚å–® ${order.id} å·²ç¢ºèª`);

    // ç™¼é€åˆ°å…¨åŸŸäº‹ä»¶ç¸½ç·š
    order.context().dispatchEvent('NOTIFICATION:ORDER_CONFIRMED', {
      orderId: order.id,
      userId: order.props.userId
    });
  }
}
```

### 2. **å…¨åŸŸäº‹ä»¶ç®¡ç†**
```typescript
import { Context } from '@type-ddd/core';

// å‰µå»ºå…¨åŸŸäº‹ä»¶ä¸Šä¸‹æ–‡
const globalContext = Context.events();

// è¨‚é–±äº‹ä»¶
globalContext.subscribe('NOTIFICATION:ORDER_CONFIRMED', (event) => {
  const { orderId, userId } = event.detail[0];
  console.log(`ç™¼é€ç¢ºèªé€šçŸ¥çµ¦ç”¨æˆ¶ ${userId}`);
});

// ç™¼é€äº‹ä»¶
globalContext.dispatchEvent('NOTIFICATION:ORDER_CONFIRMED', {
  orderId: 'order-123',
  userId: 'user-456'
});
```

## ğŸ“Š **Result çµ„åˆèˆ‡é©—è­‰**

### 1. **çµ„åˆå¤šå€‹ Result**
```typescript
import { Result, Ok, Fail } from '@type-ddd/core';

// å‰µå»ºå¤šå€‹ Value Objects
const emailResult = Email.create('user@example.com');
const nameResult = Name.create('John Doe');
const ageResult = Age.create(25);

// çµ„åˆçµæœ
const combinedResult = Result.combine([emailResult, nameResult, ageResult]);

if (combinedResult.isOk()) {
  // æ‰€æœ‰é©—è­‰éƒ½é€šé
  const user = User.create({
    email: emailResult.value(),
    name: nameResult.value(),
    age: ageResult.value()
  });
} else {
  // è™•ç†éŒ¯èª¤
  console.error('é©—è­‰å¤±æ•—:', combinedResult.error());
}
```

### 2. **æ‰¹é‡å‰µå»º Value Objects**
```typescript
import { ValueObject, Class } from '@type-ddd/core';

// å®šç¾©å‰µå»ºé…ç½®
const emailConfig = Class<EmailProps>(Email, { value: 'user@example.com' });
const nameConfig = Class<NameProps>(Name, { value: 'John Doe' });
const ageConfig = Class<AgeProps>(Age, { value: 25 });

// æ‰¹é‡å‰µå»º
const { result, data } = ValueObject.createMany([emailConfig, nameConfig, ageConfig]);

if (result.isOk()) {
  // ç²å–å‰µå»ºçš„å¯¦ä¾‹
  const email = data.next().value() as Email;
  const name = data.next().value() as Name;
  const age = data.next().value() as Age;

  // ä½¿ç”¨é€™äº›å¯¦ä¾‹
  const user = User.create({ email, name, age });
} else {
  console.error('æ‰¹é‡å‰µå»ºå¤±æ•—:', result.error());
}
```

## ğŸ¨ **Angular æ•´åˆ**

### 1. **æœå‹™å±¤æ•´åˆ**
```typescript
import { Injectable } from '@angular/core';
import { User } from '../domain/entities/user.entity';
import { UserRepository } from '../domain/repositories/user.repository';

@Injectable({
  providedIn: 'root'
})
export class UserService {
  constructor(private userRepository: UserRepository) {}

  async createUser(email: string, name: string, age: number): Promise<Result<User>> {
    // å‰µå»º Value Objects
    const emailResult = Email.create(email);
    const nameResult = Name.create(name);
    const ageResult = Age.create(age);

    // çµ„åˆçµæœ
    const combinedResult = Result.combine([emailResult, nameResult, ageResult]);
    if (combinedResult.isFail()) {
      return Fail(combinedResult.error());
    }

    // å‰µå»ºç”¨æˆ¶å¯¦é«”
    const userResult = User.create({
      email: emailResult.value(),
      name: nameResult.value(),
      age: ageResult.value()
    });

    if (userResult.isFail()) {
      return Fail(userResult.error());
    }

    // ä¿å­˜åˆ°è³‡æ–™åº«
    const savedUser = await this.userRepository.save(userResult.value());
    return Ok(savedUser);
  }
}
```

### 2. **çµ„ä»¶å±¤æ•´åˆ**
```typescript
import { Component } from '@angular/core';
import { UserService } from '../services/user.service';
import { Result } from '@type-ddd/core';

@Component({
  selector: 'app-user-form',
  template: `
    <form (ngSubmit)="onSubmit()">
      <input [(ngModel)]="email" placeholder="Email" />
      <input [(ngModel)]="name" placeholder="Name" />
      <input [(ngModel)]="age" type="number" placeholder="Age" />
      <button type="submit">å‰µå»ºç”¨æˆ¶</button>
    </form>

    <div *ngIf="error" class="error">{{ error }}</div>
    <div *ngIf="success" class="success">{{ success }}</div>
  `
})
export class UserFormComponent {
  email = '';
  name = '';
  age = 0;
  error = '';
  success = '';

  constructor(private userService: UserService) {}

  async onSubmit() {
    this.error = '';
    this.success = '';

    const result = await this.userService.createUser(this.email, this.name, this.age);

    if (result.isOk()) {
      this.success = 'ç”¨æˆ¶å‰µå»ºæˆåŠŸï¼';
      this.resetForm();
    } else {
      this.error = result.error();
    }
  }

  private resetForm() {
    this.email = '';
    this.name = '';
    this.age = 0;
  }
}
```

## ğŸ§ª **æ¸¬è©¦ç­–ç•¥**

### 1. **Value Object æ¸¬è©¦**
```typescript
import { Email } from './email.value-object';

describe('Email Value Object', () => {
  it('æ‡‰è©²å‰µå»ºæœ‰æ•ˆçš„é›»å­éƒµä»¶', () => {
    const result = Email.create('test@example.com');
    expect(result.isOk()).toBe(true);
    expect(result.value().get('value')).toBe('test@example.com');
  });

  it('æ‡‰è©²æ‹’çµ•ç„¡æ•ˆçš„é›»å­éƒµä»¶', () => {
    const result = Email.create('invalid-email');
    expect(result.isFail()).toBe(true);
    expect(result.error()).toBe('ç„¡æ•ˆçš„é›»å­éƒµä»¶æ ¼å¼');
  });

  it('æ‡‰è©²æ­£ç¢ºæå–åŸŸå', () => {
    const email = Email.create('user@example.com').value();
    expect(email.getDomain()).toBe('example.com');
  });
});
```

### 2. **Entity æ¸¬è©¦**
```typescript
import { User } from './user.entity';
import { Email } from './email.value-object';

describe('User Entity', () => {
  it('æ‡‰è©²å‰µå»ºæœ‰æ•ˆçš„ç”¨æˆ¶', () => {
    const email = Email.create('test@example.com').value();
    const result = User.create({ email, name: 'John Doe', isActive: true });

    expect(result.isOk()).toBe(true);
    expect(result.value().props.name).toBe('John Doe');
  });

  it('æ‡‰è©²èƒ½å¤ æ¿€æ´»å’Œåœç”¨ç”¨æˆ¶', () => {
    const email = Email.create('test@example.com').value();
    const user = User.create({ email, name: 'John Doe', isActive: false }).value();

    user.activate();
    expect(user.props.isActive).toBe(true);

    user.deactivate();
    expect(user.props.isActive).toBe(false);
  });
});
```

## ğŸ“ **å°ˆæ¡ˆçµæ§‹å»ºè­°**

```
src/
â”œâ”€â”€ app/
â”‚   â”œâ”€â”€ domain/
â”‚   â”‚   â”œâ”€â”€ entities/
â”‚   â”‚   â”‚   â”œâ”€â”€ user.entity.ts
â”‚   â”‚   â”‚   â””â”€â”€ order.entity.ts
â”‚   â”‚   â”œâ”€â”€ value-objects/
â”‚   â”‚   â”‚   â”œâ”€â”€ email.vo.ts
â”‚   â”‚   â”‚   â””â”€â”€ money.vo.ts
â”‚   â”‚   â”œâ”€â”€ aggregates/
â”‚   â”‚   â”‚   â””â”€â”€ order.aggregate.ts
â”‚   â”‚   â”œâ”€â”€ repositories/
â”‚   â”‚   â”‚   â””â”€â”€ user.repository.ts
â”‚   â”‚   â””â”€â”€ events/
â”‚   â”‚       â””â”€â”€ order.events.ts
â”‚   â”œâ”€â”€ application/
â”‚   â”‚   â”œâ”€â”€ services/
â”‚   â”‚   â”‚   â””â”€â”€ user.service.ts
â”‚   â”‚   â””â”€â”€ use-cases/
â”‚   â”‚       â””â”€â”€ create-user.use-case.ts
â”‚   â””â”€â”€ interface/
â”‚       â”œâ”€â”€ components/
â”‚       â”‚   â””â”€â”€ user-form/
â”‚       â””â”€â”€ pages/
â”‚           â””â”€â”€ user-list/
â””â”€â”€ shared/
    â”œâ”€â”€ base/
    â”‚   â””â”€â”€ base.entity.ts
    â””â”€â”€ utils/
        â””â”€â”€ result.utils.ts
```

## ğŸ”§ **æœ€ä½³å¯¦è¸**

### 1. **éŒ¯èª¤è™•ç†**
- å§‹çµ‚ä½¿ç”¨ `Result` é¡å‹ä¾†è™•ç†æˆåŠŸ/å¤±æ•—æƒ…æ³
- æä¾›æœ‰æ„ç¾©çš„éŒ¯èª¤è¨Šæ¯
- åœ¨æ‡‰ç”¨å±¤è™•ç†éŒ¯èª¤ä¸¦è½‰æ›ç‚ºç”¨æˆ¶å‹å¥½çš„è¨Šæ¯

### 2. **é©—è­‰**
- åœ¨ Value Object å’Œ Entity ä¸­å¯¦ç¾éœæ…‹é©—è­‰æ–¹æ³•
- ä½¿ç”¨ `Result.combine` ä¾†çµ„åˆå¤šå€‹é©—è­‰çµæœ
- åœ¨å‰µå»ºå¯¦é«”ä¹‹å‰é©—è­‰æ‰€æœ‰è¼¸å…¥

### 3. **äº‹ä»¶é©…å‹•**
- ä½¿ç”¨é ˜åŸŸäº‹ä»¶ä¾†è§£è€¦æ¥­å‹™é‚è¼¯
- åœ¨èšåˆæ ¹ä¸­æ·»åŠ å’Œåˆ†ç™¼äº‹ä»¶
- ä½¿ç”¨å…¨åŸŸäº‹ä»¶ç¸½ç·šé€²è¡Œè·¨é‚Šç•Œé€šä¿¡

### 4. **ä¸å¯è®Šæ€§**
- Value Object æ‡‰è©²æ˜¯ä¸å¯è®Šçš„
- ä½¿ç”¨ `clone` æ–¹æ³•ä¾†å‰µå»ºå¯¦é«”çš„å‰¯æœ¬
- é¿å…ç›´æ¥ä¿®æ”¹å¯¦é«”çš„å…§éƒ¨ç‹€æ…‹

### 5. **æ¸¬è©¦**
- ç‚ºæ¯å€‹ Value Object å’Œ Entity ç·¨å¯«æ¸¬è©¦
- æ¸¬è©¦æ¥­å‹™è¦å‰‡å’Œé©—è­‰é‚è¼¯
- ä½¿ç”¨æ¸¬è©¦é©…å‹•é–‹ç™¼ä¾†è¨­è¨ˆé ˜åŸŸæ¨¡å‹

## ğŸ“– **åƒè€ƒè³‡æº**

- [@type-ddd/core å®˜æ–¹æ–‡æª”](https://github.com/4lessandrodev/type-ddd)
- [rich-domain å®˜æ–¹æ–‡æª”](https://github.com/4lessandrodev/rich-domain)
- [Domain-Driven Design å®˜æ–¹ç¶²ç«™](https://domainlanguage.com/)
- [Angular å®˜æ–¹æ–‡æª”](https://angular.io/docs)

## ğŸš¨ **å¸¸è¦‹å•é¡Œ**

### Q: å¦‚ä½•è™•ç†ç•°æ­¥æ“ä½œï¼Ÿ
A: ä½¿ç”¨ `async/await` èˆ‡ `Result` é¡å‹çµåˆï¼š

```typescript
async function saveUser(user: User): Promise<Result<User>> {
  try {
    const savedUser = await this.repository.save(user);
    return Ok(savedUser);
  } catch (error) {
    return Fail(`ä¿å­˜ç”¨æˆ¶å¤±æ•—: ${error.message}`);
  }
}
```

### Q: å¦‚ä½•è™•ç†è¤‡é›œçš„æ¥­å‹™è¦å‰‡ï¼Ÿ
A: å°‡è¤‡é›œçš„æ¥­å‹™é‚è¼¯å°è£åœ¨ Entity æˆ– Aggregate çš„æ–¹æ³•ä¸­ï¼š

```typescript
public canCancel(): boolean {
  return this.props.status === OrderStatus.PENDING &&
         this.props.items.length > 0;
}

public cancel(): Result<Order> {
  if (!this.canCancel()) {
    return Fail('è¨‚å–®ç„¡æ³•å–æ¶ˆ');
  }

  this.props.status = OrderStatus.CANCELLED;
  this.addEvent(new OrderCancelledEvent(this.props.id));
  return Ok(this);
}
```

### Q: å¦‚ä½•è™•ç†è·¨èšåˆçš„æ¥­å‹™é‚è¼¯ï¼Ÿ
A: ä½¿ç”¨é ˜åŸŸæœå‹™æˆ–æ‡‰ç”¨æœå‹™ä¾†å”èª¿å¤šå€‹èšåˆï¼š

```typescript
@Injectable()
export class OrderService {
  async processOrder(orderId: string, payment: Payment): Promise<Result<void>> {
    const order = await this.orderRepository.findById(orderId);
    const user = await this.userRepository.findById(order.props.userId);

    // å”èª¿å¤šå€‹èšåˆçš„æ¥­å‹™é‚è¼¯
    const result = await this.processOrderPayment(order, user, payment);
    return result;
  }
}
```
