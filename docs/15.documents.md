# DocuParse (Next.js) 功能盤點與 Angular 現代化重現方案

本文件分析 `e/DocuParse-main/`（Next.js）現有功能，並規劃如何在本專案以 Angular 20 與 DDD 分層（`application/domain/infrastructure/interface/shared`）現代化重現 [[memory:5079044]].

## 一、Next.js 專案功能盤點（DocuParse）

- 功能總覽
  - 文件上傳 UI（拖拽/點擊）與立即處理
  - 伺服器動作（Server Action）接收檔案、轉為 Data URI、呼叫 AI 流程
  - Genkit + Google AI 模型（`gemini-2.0-flash`）解析文件，抽取工項清單
  - 結果呈現與可編輯表格：描述、數量、單價、總價；自動換算；列新增/刪除
  - 匯出功能：CSV、JSON
  - 錯誤提示（Toast）、Token 用量徽章（Badge）

- 主要檔案/模組
  - AI 流程：`src/ai/genkit.ts`、`src/ai/flows/extract-work-items.ts`
  - Server Action：`src/app/actions.ts`
  - UI 頁面：`src/app/page.tsx`
  - 可編輯表格：`src/components/work-items-table.tsx`
  - UI 套件：shadcn/ui + Tailwind、Radix、lucide-react

- 核心資料模型（AI 輸出）
  - `workItems: Array<{ item: string; quantity: number; price: number; unitPrice: number }>`
  - `totalTokens: number`

## 二、Angular 20 現代化重現（DDD 對應設計）

- 路由與頁面
  - `interface/pages/public/documents/extract`：文件解析頁（Standalone Component）
  - 入口包含：上傳區塊、處理中狀態、結果區塊（@defer/@placeholder/@loading）

- 介面層（interface）
  - `components/documents/document-upload`：拖拽/點擊上傳，接受 `File`
  - `components/documents/work-items-table`：可編輯表格，內建自動換算、CSV/JSON 匯出
  - 提示/徽章：Angular Material 或自建輕量元件（沿用 Tailwind 亦可）

- 應用層（application）
  - DTO：
    ```ts
    export interface ExtractWorkItemsInput { documentDataUri: string; }
    export interface WorkItem { item: string; quantity: number; price: number; unitPrice: number; }
    export interface ExtractWorkItemsOutput { workItems: WorkItem[]; totalTokens: number; }
    ```
  - 用例（Use Case）：`extract-work-items.use-case.ts`
    - 責任：調用服務、封裝錯誤處理、回傳 `ExtractWorkItemsOutput`
  - 應用服務：`document-extraction.service.ts`（signals 狀態：`isLoading`, `error`, `result`）

- 領域層（domain）
  - 實體：`WorkItem`（可引入 `Money`/`Quantity` 值物件以強化計算/格式化）
  - 規則：單價與總價雙向推導（避免除以 0）

- 基礎設施層（infrastructure）
  - 外部服務：`external-services/ai-extraction.service.ts`
    - 以 `HttpClient` 呼叫後端 `/api/extract`（或 Firebase Functions）包裹 Genkit 流程
  - 攔截器：錯誤轉換、Loading/Logging（可用現有 `interceptors` 模組）
  - 設定：`config/environment.service.ts` 管理 API_BASE、AI 模型設定

- 共享層（shared）
  - `utils/export.util.ts`：CSV/JSON 匯出
  - `types`/`models`：共用型別、模型
  - `components`：Loading/Toast/Badge 等可重用 UI

## 三、Angular 實作重點（範例片段）

- 上傳 → 呼叫用例（signals）
```ts
// interface/pages/.../documents-extract.page.ts
readonly isLoading = signal(false);
readonly result = signal<ExtractWorkItemsOutput | null>(null);
readonly error = signal<string | null>(null);

async onFileSelected(file: File) {
  this.isLoading.set(true);
  this.error.set(null);
  try {
    const dataUri = await this.fileToDataUri(file);
    const output = await this.extractWorkItemsUseCase.execute({ documentDataUri: dataUri });
    this.result.set(output);
  } catch (e) {
    this.error.set('解析失敗，請確認檔案是否有效。');
  } finally {
    this.isLoading.set(false);
  }
}
```

- 可編輯表格（自動換算）
```ts
updateRow(i: number, patch: Partial<WorkItem>) {
  const rows = [...this.rows()];
  const row = { ...rows[i], ...patch } as WorkItem;
  if (patch.quantity !== undefined || patch.unitPrice !== undefined) {
    row.price = +(row.quantity * row.unitPrice).toFixed(2);
  } else if (patch.price !== undefined && row.quantity > 0) {
    row.unitPrice = +(row.price / row.quantity).toFixed(2);
  }
  rows[i] = row;
  this.rows.set(rows);
}
```

- 匯出（CSV/JSON）
```ts
exportToCSV(items: WorkItem[]) { /* 以 Blob 產出並下載 */ }
exportToJSON(items: WorkItem[]) { /* 以 Blob 產出並下載 */ }
```

## 四、UX/安全/效能

- UX
  - `@defer` 延後非關鍵內容；Skeleton/Spinner；錯誤 Toast
  - Material Table 或 CDK Table；鍵盤可用性（ARIA）、可聚焦編輯
- 安全
  - 僅允許安全 MIME；限制大小；於後端驗證/掃描
  - 切勿在前端暴露 AI 憑證；一律經後端代理 Genkit
- 效能
  - 大檔以串流/分段（後端）；前端僅做 Data URI（或改直傳 Storage 再觸發處理）
  - 避免過度變更檢測：Signals + OnPush

## 五、落地任務清單（精簡）

- 路由與頁面：`/documents/extract` 建立頁面與上傳元件
- 應用層：DTO、UseCase、Service（signals 狀態）
- 基礎設施：AI 抽取 API 封裝、攔截器、環境設定
- 介面層：可編輯表格、CSV/JSON 匯出、Toast/Badge
- 測試：
  - 單元：用例/服務/工具；
  - e2e：上傳→抽取→編輯→匯出

以上規劃可在不改變現有 DDD 分層原則下，等價重現 DocuParse 的上傳解析與結果編輯體驗，並升級為 Angular 20 現代化實作（signals、@defer、Material/CDK、攔截器與型別安全）。

## 六、Next.js 專案完整內容（功能明細與對照）

- 目錄索引（摘要）
  - `src/ai/genkit.ts`：初始化 Genkit，掛載 `googleai` 插件與 `gemini-2.0-flash` 模型
  - `src/ai/flows/extract-work-items.ts`：定義 `extractWorkItemsFlow` 與 `extractWorkItemsPrompt`，Zod schema 定義輸入/輸出
  - `src/ai/dev.ts`：`dotenv` 引入與 flow 載入（開發用）
  - `src/app/actions.ts`：Server Action，接收 `FormData` 檔案、轉 Data URI、驗證、呼叫 AI 流程
  - `src/app/page.tsx`：單頁 UI，負責上傳、loading、錯誤 toast、渲染結果表格與 token 徽章
  - `src/components/work-items-table.tsx`：可編輯表格、即時計算、列新增/刪除、CSV/JSON 匯出
  - `src/components/ui/*`：shadcn + Radix 驅動的 UI 基礎元件（button/input/card/table/toast 等）
  - `src/hooks/use-toast.ts`：Toast 狀態管理
  - `src/lib/utils.ts`：`cn` 輔助

- 功能拆解
  - 檔案上傳
    - 支援 `.pdf/.doc/.docx`；透過隱藏的 `<input type="file">` 觸發
    - 上傳即觸發 Server Action，避免手動送出表單
  - Server Action 流程
    - 讀取 `File` → `ArrayBuffer` → Base64 → Data URI（`data:<mime>;base64,<data>`）
    - 驗證 Data URI（Zod：`startsWith('data:')`）
    - 呼叫 `extractWorkItems(validatedInput.data)`
  - Genkit Flow
    - Prompt 使用 `{{media url=documentDataUri}}` 注入文件
    - 規則：數量缺省為 1；單價缺省由 `price/quantity` 計
    - 回傳 `workItems` 與 `totalTokens`
  - 結果呈現
    - 顯示 `fileName` 與 `totalTokens` 徽章
    - 表格可編輯，三者互算（數量/單價/總價）
    - 匯出 CSV、JSON
  - 通知與樣式
    - `useToast` 顯示錯誤
    - Tailwind 主題色系、暗色模式；icon 使用 `lucide-react`

- Angular 重現對照（精細）
  - 上傳區塊
    - `interface/components/documents/document-upload`：使用 `<input type="file">` 包裹自訂 UI；(signals) 管理 hover/drag 狀態
    - 無障礙：`role="button"`、`tabIndex="0"`、鍵盤 Enter 觸發
  - 動作層替代 Server Action
    - 前端：呼叫 `application/use-cases/extract-work-items.use-case.ts`
    - 後端：`/api/extract`（Node/Firebase Functions/雲端），封裝 Genkit 調用
  - AI 整合
    - 推薦在後端完成（避免金鑰外洩）；若必須前端直呼，需以 Token Broker/短期簽章保護
  - 結果呈現與表格
    - `interface/components/documents/work-items-table`：使用 Angular CDK Table 或 Material Table，支援 inline edit
    - 計算規則以純函數封裝於 `shared/utils/workitem.util.ts`
  - 匯出
    - `shared/utils/export.util.ts`：`
      - toCSV(rows: WorkItem[]) => Blob
      - toJSON(rows: WorkItem[]) => Blob
      - downloadBlob(blob, filename)
      `
  - Toast 與徽章
    - 可使用 Angular Material Snackbar + 自建 `Badge` 元件；或沿用 Tailwind 實作輕量樣式
  - 樣式與可達性
    - Tailwind 可並存；或僅用 Material 3 主題

## 七、Angular 目錄對應建議（與現有 DDD 對齊）

- `src/app/interface/pages/public/documents/extract`：頁面元件（Standalone）
- `src/app/interface/components/documents/document-upload`：檔案上傳元件
- `src/app/interface/components/documents/work-items-table`：表格元件
- `src/app/application/dto/documents`：`extract-work-items.dto.ts`
- `src/app/application/use-cases/extract-work-items.use-case.ts`
- `src/app/application/services/document-extraction.service.ts`
- `src/app/infrastructure/external-services/ai-extraction.service.ts`
- `src/app/shared/utils/{export.util.ts, workitem.util.ts}`

## 八、API 與環境設定建議

- 後端路由（示意）
  - `POST /api/extract` → { documentDataUri } → { workItems, totalTokens }
  - 驗證：MIME 白名單、大小限制、掃描（如需）
  - 錯誤碼：422（格式錯）、413（過大）、500（AI/外部依賴）
- 環境變數
  - `AI_API_BASE`、`AI_MODEL`、`AI_KEY`（僅後端）
  - Angular 端僅保留 `API_BASE_URL`（由 `environment.ts` 提供）

## 九、任務分解與優先順序（可兩迭代完成）

1. 介面雛型：上傳元件 + 頁面框架 + Loading/Toast
2. 後端 `/api/extract`：接入 Genkit Flow；回傳固定 schema
3. 用例/服務：串接 API、signals 狀態；錯誤處理
4. 表格元件：可編輯、三者換算、CSV/JSON 匯出
5. 細節：無障礙、鍵盤操作、ARIA、空狀態展現
6. 驗證：單元/整合/e2e（上傳→抽取→編輯→匯出）

## 十、驗收標準（Done 定義）

- 上傳任一支援檔案，能成功取得 AI 抽取之 `workItems` 並顯示
- 任何欄位編輯後，數值自動正確換算，無除以 0 / NaN
- 匯出 CSV/JSON 與畫面一致
- 錯誤情境：無檔案、檔案毀損、格式不符、AI 失敗 → 清楚訊息與恢復能力
- 不暴露 AI Key；環境設定分離；型別與 linter 無錯

## 十一、交互順序（Next.js 現況 → Angular 對照）

- Happy Path（文件成功解析）
  1) 使用者點擊上傳區塊 → 觸發隱藏 `input[type=file]`（Next: `handleUploadClick` 重置 value 允許重傳同檔）
  2) `onChange` 取得 `File` →（Next）以 `useActionState` 呼叫 Server Action；（Angular）呼叫 `ExtractWorkItemsUseCase`
  3) 顯示 Loading（Next: `isPending` + Spinner；Angular: `isLoading` signal + `@defer` 區塊）
  4) 後端：將檔案轉為 Data URI → 驗證/清洗 → 呼叫 Genkit Flow（Gemini）→ 回傳 `{ workItems, totalTokens }`
  5) 前端：渲染結果卡片 → 顯示 `fileName` 與 `totalTokens` 徽章 → 顯示可編輯表格
  6) 使用者在表格編輯任一路徑（數量/單價/總價）→ 即時計算另一側數值（避免除以 0）
  7) 匯出：點選 CSV/JSON → 以 Blob 下載

- 失敗/例外（使用者回饋）
  - 未選檔或空檔：顯示錯誤（Next: toast；Angular: snackbar/toast）
  - Data URI 驗證錯誤：顯示錯誤
  - AI 回應為空或結構不符：顯示錯誤訊息 + 保留重試能力
  - 網路/後端錯誤：顯示可重試提示，維持使用者輸入狀態

- 可達性與鍵盤互動
  - 上傳區塊具 `role="button"`、`tabIndex`；Enter 觸發
  - 表格欄位可聚焦、方向鍵/Tab 移動、螢幕閱讀器描述

## 十二、細節實現（Angular 現代化）

- 路由與頁面（Standalone + Signals + @defer）
  - 路徑：`/documents/extract`
  - 狀態：`isLoading`, `error`, `result`（signals）
  - 模板：
    - 上傳區塊（點擊/鍵盤觸發 input）
    - `@if (isLoading()) { <spinner/> }`
    - `@defer (when result()) { <results-card/> } @placeholder { <skeleton/> } @loading { <spinner/> }`

- 應用層（Use Case + Service）
  - `ExtractWorkItemsUseCase.execute(input: ExtractWorkItemsInput)`：
    - 呼叫 `DocumentExtractionService.extract(input)`；
    - 轉換/驗證；拋出應用層異常供介面層呈現
  - `DocumentExtractionService`：
    - 封裝 API 呼叫、統一錯誤訊息（i18n 可加值）

- 基礎設施層（外部服務/攔截器）
  - `AiExtractionHttpService.extract(dto)`：POST `/api/extract`
  - 攔截器：
    - `error.interceptor.ts`：將技術錯誤轉為使用者可讀訊息
    - `auth-http.interceptor.ts`（如需 Auth）

- 介面層（上傳 + 表格 + 匯出）
  - 上傳元件：
    - `accept` 限制：`.pdf,.doc,.docx` + MIME 白名單
    - 轉 Data URI 可於前端或後端（建議後端）
  - 表格元件：
    - 使用 Angular CDK Table 或 Material Table；每列為 `WorkItem`
    - 編輯事件觸發計算：
      - 當 `quantity`/`unitPrice` 變更 → `price = quantity * unitPrice`
      - 當 `price` 變更且 `quantity > 0` → `unitPrice = price / quantity`
    - 空列表狀態與「新增列」按鈕
  - 匯出工具：
    - `export.util.ts`：`toCSV(rows)`, `toJSON(rows)`, `download(blob, name)`

- 安全/穩健性
  - 檔案大小上限（如 10MB）；拋 413 於後端
  - MIME 檢查與副檔名比對；拒絕可疑內容
  - 後端保護 AI 金鑰；前端僅呼叫自家 API

- 效能/UX
  - `@defer`、Skeleton、Spinner，縮短感知等待
  - 伺服器壓縮與快取（對靜態 UI 資源）
  - 大檔以後端處理（必要時改用 Storage 直傳 + 任務輪詢）

## 十三、實作步驟（可直接落地）

1) 建頁與路由
   - `interface/pages/public/documents/extract` 建立 Standalone Component；在 `app.routes.ts` 加路由

2) 建 DTO/型別
   - `application/dto/documents/extract-work-items.dto.ts` 定義 `ExtractWorkItemsInput/Output`、`WorkItem`

3) 建 Use Case/Service（application）
   - `use-cases/extract-work-items.use-case.ts`
   - `services/document-extraction.service.ts`（signals 狀態 + 方法）

4) 基礎設施與環境
   - `infrastructure/external-services/ai-extraction.service.ts`（`HttpClient`）
   - `infrastructure/config/environment.service.ts` 讀取 `API_BASE_URL`

5) UI 元件
   - `interface/components/documents/document-upload`
   - `interface/components/documents/work-items-table`

6) 匯出工具
   - `shared/utils/export.util.ts`；`shared/utils/workitem.util.ts`

7) 攔截器與錯誤處理
   - 啟用 `error.interceptor.ts`，統一錯誤訊息

8) 測試
   - 單元：計算工具/Use Case/Service
   - e2e：上傳→抽取→編輯→匯出完整流程

## 十四、基於當前架構的落地文件樹（完整新增/調整項）

以下文件樹遵循現有 DDD 結構（`application/domain/infrastructure/interface/shared`），並盡量沿用專案慣例（`index.ts` barrel、Standalone Components、inline template 可接受）。僅列出新增/變更重點與必備檔。

```text
src/
  app/
    app.routes.ts                       # 變更：新增 /documents/extract 路由
    application/
      dto/
        documents/
          extract-work-items.dto.ts     # ExtractWorkItemsInput/Output、WorkItem DTO
          index.ts
      services/
        document-extraction.service.ts  # signals 狀態、呼叫 infra 服務
        index.ts
      use-cases/
        extract-work-items.use-case.ts  # 協調服務/驗證/錯誤轉換
        index.ts
    infrastructure/
      external-services/
        ai-extraction.service.ts        # HttpClient 封裝 POST /api/extract
        index.ts
      config/
        environment.service.ts          # 如需擴充 API_BASE_URL 讀取（若已存在僅補常數）
    interface/
      pages/
        public/
          documents/
            extract/
              documents-extract.page.ts          # Standalone Page：上傳、loading、結果呈現
              documents-extract.page.spec.ts     # 單元測試（可先擱置）
      components/
        documents/
          document-upload/
            document-upload.component.ts         # 檔案上傳（點擊/鍵盤/accept）
          work-items-table/
            work-items-table.component.ts        # 可編輯表格（即時計算/新增刪除/匯出）
          results-card.component.ts              # 檔名/總 token/動作區（可與 page 合併）
          tokens-badge.component.ts              # Token 徽章（可選）
    shared/
      types/
        documents/
          work-item.type.ts                      # 共用型別（若 DTO 已含可 alias）
          index.ts
      utils/
        export.util.ts                           # toCSV/toJSON/downloadBlob
        workitem.util.ts                         # 三者換算純函數
        index.ts
```

輔助（可選）：

```text
src/
  app/
    infrastructure/
      interceptors/
        error.interceptor.ts             # 如需統一錯誤轉換（若已存在沿用）
```

## 十五、必要程式碼變更（關鍵片段）

- 路由註冊（`app.routes.ts`）
```ts
// 片段：新增文件解析頁
{ path: 'documents/extract', loadComponent: () => import('./interface/pages/public/documents/extract/documents-extract.page').then(m => m.DocumentsExtractPage) }
```

- DTO（`application/dto/documents/extract-work-items.dto.ts`）
```ts
export interface ExtractWorkItemsInput { documentDataUri: string; }
export interface WorkItem { item: string; quantity: number; price: number; unitPrice: number; }
export interface ExtractWorkItemsOutput { workItems: WorkItem[]; totalTokens: number; fileName?: string; }
```

- 匯出工具（`shared/utils/export.util.ts`）
```ts
export function toCSV(rows: WorkItem[]): Blob { /* ... */ }
export function toJSON(rows: WorkItem[]): Blob { /* ... */ }
export function downloadBlob(blob: Blob, filename: string): void { /* ... */ }
```

## 十六、執行順序與責任切分（落地計畫）

- 迭代 A（1-2 天）
  - 新增頁路由與 `DocumentsExtractPage` 骨架（signals 狀態）
  - 建立 DTO/UseCase/Service 與 `AiExtractionHttpService` 空實作
  - 上傳元件（accept 限制、鍵盤可用）

- 迭代 B（1-2 天）
  - 後端 API 接通（或對接既有 Functions）；前端完成 `extract` 串接
  - 結果卡與徽章呈現；錯誤處理與 Toast/Snackbar

- 迭代 C（1-2 天）
  - 表格元件：編輯、三者換算、列新增/刪除
  - 匯出 CSV/JSON 工具完成

- 迭代 D（1 天）
  - 單元/整合測試；e2e happy path
  - 可達性（ARIA/鍵盤）與微調（loading/skeleton）

