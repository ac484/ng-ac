# 合約功能完整實現計畫 v2.0 - 完美重現 NextJS 專案

## 📋 實現概述

基於 `docs/12.construct.md` 的規劃和 NextJS 專案深度分析，本計畫將實現完整的專案與合約管理系統，包含專案管理、任務管理、合約管理、AI 功能等所有核心功能，完美重現 NextJS 專案的所有特性，並使用 Angular 20 + Material 20 的現代化實現方案。

## 🎯 實現目標

### 核心功能
#### 專案管理系統
- 🔄 專案儀表板（Dashboard）
- 🔄 專案列表與管理
- 🔄 專案詳情與任務樹
- 🔄 任務狀態管理
- 🔄 價值分配與進度追蹤

#### 合約管理系統
- ✅ 合約查看（已實現）
- 🔄 合約新增/編輯
- 🔄 CSV 匯出功能
- 🔄 付款管理 CRUD
- 🔄 變更單管理 CRUD
- 🔄 合約狀態工作流
- 🔄 多標籤頁詳情展示
- 🔄 付款進度追蹤
- 🔄 變更單影響分析
- 🔄 版本歷史時間軸

#### AI 功能系統
- 🔄 AI 合約摘要服務
- 🔄 AI 子任務建議
- 🔄 文件處理與分析

#### 權限控制系統
- 🔄 用戶認證與授權
- 🔄 角色基礎權限控制

### 技術要求
- 嚴格遵循 DDD 架構
- 使用 Angular 20 現代特性
- 整合 Angular Material 20 最新組件
- 實現 AI 優化檔案標頭
- 支援響應式設計
- 完整的錯誤處理
- 使用 Angular 20 的 Signals 和 Control Flow
- 實現現代化的狀態管理
- 支援 AI 功能整合

## 🏗️ 完整文件結構規劃（擴展版 - 包含專案管理）

```
src/app/
├── domain/
│   ├── entities/
│   │   ├── contract/
│   │   │   ├── contract.entity.ts ✅ 已實現
│   │   │   ├── payment.entity.ts ✅ 已實現
│   │   │   ├── change-order.entity.ts ✅ 已實現
│   │   │   ├── contract-version.entity.ts ✅ 已實現
│   │   │   └── index.ts ✅ 已實現
│   │   ├── project/
│   │   │   ├── project.entity.ts 🔄 需要新增
│   │   │   ├── task.entity.ts 🔄 需要新增
│   │   │   └── index.ts 🔄 需要新增
│   │   └── index.ts ✅ 已實現
│   └── repositories/
│       ├── contract.repository.ts ✅ 已實現
│       ├── project.repository.ts 🔄 需要新增
│       └── index.ts ✅ 已實現
├── application/
│   ├── dto/
│   │   ├── contract/
│   │   │   ├── contract.dto.ts ✅ 已實現
│   │   │   ├── payment.dto.ts 🔄 需要新增
│   │   │   ├── change-order.dto.ts 🔄 需要新增
│   │   │   ├── contract-version.dto.ts 🔄 需要新增
│   │   │   └── index.ts ✅ 已實現
│   │   ├── project/
│   │   │   ├── project.dto.ts 🔄 需要新增
│   │   │   ├── task.dto.ts 🔄 需要新增
│   │   │   └── index.ts 🔄 需要新增
│   │   └── index.ts ✅ 已實現
│   ├── services/
│   │   ├── contract/
│   │   │   ├── contract-application.service.ts ✅ 已實現
│   │   │   ├── contract-export.service.ts 🔄 需要新增
│   │   │   ├── contract-form.service.ts 🔄 需要新增
│   │   │   └── index.ts ✅ 已實現
│   │   ├── project/
│   │   │   ├── project-application.service.ts 🔄 需要新增
│   │   │   ├── project-progress.service.ts 🔄 需要新增
│   │   │   └── index.ts 🔄 需要新增
│   │   └── index.ts ✅ 已實現
│   ├── use-cases/
│   │   ├── contract/
│   │   │   ├── create-contract.use-case.ts 🔄 需要新增
│   │   │   ├── update-contract.use-case.ts 🔄 需要新增
│   │   │   ├── delete-contract.use-case.ts 🔄 需要新增
│   │   │   ├── add-payment.use-case.ts 🔄 需要新增
│   │   │   ├── add-change-order.use-case.ts 🔄 需要新增
│   │   │   └── index.ts 🔄 需要新增
│   │   ├── project/
│   │   │   ├── create-project.use-case.ts 🔄 需要新增
│   │   │   ├── update-project.use-case.ts 🔄 需要新增
│   │   │   ├── delete-project.use-case.ts 🔄 需要新增
│   │   │   ├── add-task.use-case.ts 🔄 需要新增
│   │   │   ├── update-task-status.use-case.ts 🔄 需要新增
│   │   │   └── index.ts 🔄 需要新增
│   │   └── index.ts ✅ 已實現
│   └── validators/
│       └── contract/
│           ├── contract.validator.ts 🔄 需要新增
│           ├── payment.validator.ts 🔄 需要新增
│           ├── change-order.validator.ts 🔄 需要新增
│           └── index.ts 🔄 需要新增
├── infrastructure/
│   ├── persistence/
│   │   └── repositories/
│   │       ├── contract/
│   │       │   ├── in-memory-contract.repository.ts ✅ 已實現
│   │       │   ├── firebase-contract.repository.ts 🔄 需要新增
│   │       │   └── index.ts ✅ 已實現
│   │       └── project/
│   │           ├── in-memory-project.repository.ts 🔄 需要新增
│   │           ├── firebase-project.repository.ts 🔄 需要新增
│   │           └── index.ts 🔄 需要新增
│   └── external-services/
│       └── ai/
│           ├── contract-summarizer.service.ts ✅ 已實現
│           ├── project-subtask-generator.service.ts 🔄 需要新增
│           └── index.ts 🔄 需要新增
├── interface/
│   ├── pages/
│   │   ├── construct/
│   │   │   ├── construct.page.ts ✅ 已實現
│   │   │   └── index.ts ✅ 已實現
│   │   ├── dashboard/
│   │   │   ├── dashboard.page.ts 🔄 需要新增
│   │   │   └── index.ts 🔄 需要新增
│   │   └── projects/
│   │       ├── projects-list.page.ts 🔄 需要新增
│   │       ├── project-detail.page.ts 🔄 需要新增
│   │       └── index.ts 🔄 需要新增
│   └── components/
│       ├── contracts/
│       │   ├── contracts-dashboard-stats.component.ts ✅ 已實現
│       │   ├── contracts-table.component.ts ✅ 已實現
│       │   ├── ai-summarizer-dialog.component.ts ✅ 已實現
│       │   ├── contract-form-dialog.component.ts 🔄 需要新增
│       │   ├── contract-details-sheet.component.ts 🔄 需要新增
│       │   ├── payment-management.component.ts 🔄 需要新增
│       │   ├── change-order-management.component.ts 🔄 需要新增
│       │   ├── csv-export-button.component.ts 🔄 需要新增
│       │   └── index.ts ✅ 已實現
│       ├── projects/
│       │   ├── project-progress-chart.component.ts 🔄 需要新增
│       │   ├── project-list-item.component.ts 🔄 需要新增
│       │   ├── create-project-dialog.component.ts 🔄 需要新增
│       │   ├── project-details-sheet.component.ts 🔄 需要新增
│       │   └── index.ts 🔄 需要新增
│       ├── tasks/
│       │   ├── task-item.component.ts 🔄 需要新增
│       │   ├── task-tree.component.ts 🔄 需要新增
│       │   ├── ai-subtask-suggestions.component.ts 🔄 需要新增
│       │   └── index.ts 🔄 需要新增
│       └── shared/
│           ├── dashboard-stats.component.ts 🔄 需要新增
│           ├── progress-bar.component.ts 🔄 需要新增
│           └── index.ts 🔄 需要新增
├── shared/
│   ├── types/
│   │   ├── contract/
│   │   │   ├── contract.types.ts 🔄 需要新增
│   │   │   └── index.ts 🔄 需要新增
│   │   ├── project/
│   │   │   ├── project.types.ts 🔄 需要新增
│   │   │   ├── task.types.ts 🔄 需要新增
│   │   │   └── index.ts 🔄 需要新增
│   │   └── index.ts ✅ 已實現
│   ├── utils/
│   │   ├── csv/
│   │   │   ├── csv.util.ts 🔄 需要新增
│   │   │   └── index.ts 🔄 需要新增
│   │   ├── date/
│   │   │   ├── date.util.ts 🔄 需要新增
│   │   │   └── index.ts 🔄 需要新增
│   │   ├── calculation/
│   │   │   ├── progress.util.ts 🔄 需要新增
│   │   │   ├── value.util.ts 🔄 需要新增
│   │   │   └── index.ts 🔄 需要新增
│   │   └── index.ts ✅ 已實現
│   ├── i18n/
│   │   ├── contract/
│   │   │   ├── en-US.ts 🔄 需要新增
│   │   │   ├── zh-TW.ts 🔄 需要新增
│   │   │   └── index.ts 🔄 需要新增
│   │   ├── project/
│   │   │   ├── en-US.ts 🔄 需要新增
│   │   │   ├── zh-TW.ts 🔄 需要新增
│   │   │   └── index.ts 🔄 需要新增
│   │   └── index.ts ✅ 已實現
│   └── constants/
│       ├── app.constants.ts ✅ 已實現
│       ├── contract.constants.ts 🔄 需要新增
│       ├── project.constants.ts 🔄 需要新增
│       └── index.ts ✅ 已實現
├── app.routes.ts ✅ 已實現
├── app.config.ts ✅ 已實現
├── domain/index.ts ✅ 已實現
├── application/index.ts ✅ 已實現
├── infrastructure/index.ts ✅ 已實現
└── interface/index.ts ✅ 已實現
```

## 📝 新增文件詳細規劃

### 1. Domain Layer 新增文件

#### 1.1 Payment Entity
```typescript
// src/app/domain/entities/contract/payment.entity.ts
/**
 * @ai-context {
 *   "role": "Domain/Entity",
 *   "purpose": "Payment實體-付款核心業務邏輯",
 *   "constraints": ["無外部服務依賴", "業務規則內部封裝", "聚合一致性"],
 *   "dependencies": ["Contract"],
 *   "security": "high",
 *   "lastmod": "2024-12-19"
 * }
 */

export interface Payment {
  id: string;
  amount: number;
  status: 'Paid' | 'Pending' | 'Overdue';
  requestDate: Date;
  paidDate?: Date;
  description?: string;
  invoiceNumber?: string;
}

export class PaymentEntity {
  constructor(
    public readonly id: string,
    public readonly amount: number,
    public status: Payment['status'],
    public readonly requestDate: Date,
    public paidDate?: Date,
    public readonly description?: string,
    public readonly invoiceNumber?: string
  ) {}

  static create(data: Omit<Payment, 'id'> & { id?: string }): PaymentEntity {
    return new PaymentEntity(
      data.id || crypto.randomUUID(),
      data.amount,
      data.status,
      data.requestDate,
      data.paidDate,
      data.description,
      data.invoiceNumber
    );
  }

  markAsPaid(paidDate: Date = new Date()): void {
    this.status = 'Paid';
    this.paidDate = paidDate;
  }

  markAsOverdue(): void {
    if (this.status === 'Pending') {
      this.status = 'Overdue';
    }
  }

  get isOverdue(): boolean {
    return this.status === 'Pending' && this.requestDate < new Date();
  }
}
```

#### 1.2 Change Order Entity
```typescript
// src/app/domain/entities/contract/change-order.entity.ts
/**
 * @ai-context {
 *   "role": "Domain/Entity",
 *   "purpose": "ChangeOrder實體-變更單核心業務邏輯",
 *   "constraints": ["無外部服務依賴", "業務規則內部封裝", "聚合一致性"],
 *   "dependencies": ["Contract"],
 *   "security": "high",
 *   "lastmod": "2024-12-19"
 * }
 */

export interface ChangeOrder {
  id: string;
  title: string;
  description: string;
  status: 'Approved' | 'Pending' | 'Rejected';
  date: Date;
  impact: { cost: number; scheduleDays: number };
  approvedBy?: string;
  approvedDate?: Date;
  rejectionReason?: string;
}

export class ChangeOrderEntity {
  constructor(
    public readonly id: string,
    public readonly title: string,
    public readonly description: string,
    public status: ChangeOrder['status'],
    public readonly date: Date,
    public readonly impact: { cost: number; scheduleDays: number },
    public approvedBy?: string,
    public approvedDate?: Date,
    public rejectionReason?: string
  ) {}

  static create(data: Omit<ChangeOrder, 'id'> & { id?: string }): ChangeOrderEntity {
    return new ChangeOrderEntity(
      data.id || crypto.randomUUID(),
      data.title,
      data.description,
      data.status,
      data.date,
      data.impact,
      data.approvedBy,
      data.approvedDate,
      data.rejectionReason
    );
  }

  approve(approvedBy: string): void {
    this.status = 'Approved';
    this.approvedBy = approvedBy;
    this.approvedDate = new Date();
    this.rejectionReason = undefined;
  }

  reject(rejectionReason: string): void {
    this.status = 'Rejected';
    this.rejectionReason = rejectionReason;
    this.approvedBy = undefined;
    this.approvedDate = undefined;
  }
}
```

#### 1.3 Contract Version Entity
```typescript
// src/app/domain/entities/contract/contract-version.entity.ts
/**
 * @ai-context {
 *   "role": "Domain/Entity",
 *   "purpose": "ContractVersion實體-合約版本核心業務邏輯",
 *   "constraints": ["無外部服務依賴", "業務規則內部封裝", "聚合一致性"],
 *   "dependencies": ["Contract"],
 *   "security": "medium",
 *   "lastmod": "2024-12-19"
 * }
 */

export interface ContractVersion {
  version: number;
  date: Date;
  changeSummary: string;
  changedBy?: string;
  documentUrl?: string;
}

export class ContractVersionEntity {
  constructor(
    public readonly version: number,
    public readonly date: Date,
    public readonly changeSummary: string,
    public readonly changedBy?: string,
    public readonly documentUrl?: string
  ) {}

  static create(data: Omit<ContractVersion, 'version'> & { version?: number }): ContractVersionEntity {
    return new ContractVersionEntity(
      data.version || 1,
      data.date,
      data.changeSummary,
      data.changedBy,
      data.documentUrl
    );
  }
}
```

### 2. Application Layer 新增文件

#### 2.1 Contract Export Service
```typescript
// src/app/application/services/contract/contract-export.service.ts
/**
 * @ai-context {
 *   "role": "Application/Service",
 *   "purpose": "合約匯出服務-CSV匯出與序列化",
 *   "constraints": ["純匯出邏輯", "無業務規則", "可重用性"],
 *   "dependencies": ["Contract", "CSVUtil"],
 *   "security": "low",
 *   "lastmod": "2024-12-19"
 * }
 */

import { Injectable } from '@angular/core';
import { Contract } from '../../../domain/entities/contract';

@Injectable({ providedIn: 'root' })
export class ContractExportService {
  exportToCsv(contracts: Contract[]): void {
    if (contracts.length === 0) return;

    const headers = ['ID', 'Name', 'Contractor', 'Client', 'Start Date', 'End Date', 'Total Value', 'Status', 'Scope'];
    const lines = contracts.map(c => [
      c.id,
      JSON.stringify(c.name),
      JSON.stringify(c.contractor),
      JSON.stringify(c.client),
      new Date(c.startDate).toISOString().slice(0, 10),
      new Date(c.endDate).toISOString().slice(0, 10),
      String(c.totalValue),
      c.status,
      JSON.stringify(c.scope)
    ].join(','));

    const csv = [headers.join(','), ...lines].join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `contracts_export_${new Date().toISOString().slice(0, 10)}.csv`;
    link.click();
    URL.revokeObjectURL(link.href);
  }

  exportDetailedCsv(contracts: Contract[]): void {
    if (contracts.length === 0) return;

    const headers = ['Contract ID', 'Contract Name', 'Payment ID', 'Payment Amount', 'Payment Status', 'Payment Date'];
    const lines: string[] = [];

    contracts.forEach(contract => {
      if (contract.payments.length === 0) {
        lines.push([contract.id, JSON.stringify(contract.name), '', '', '', ''].join(','));
      } else {
        contract.payments.forEach(payment => {
          lines.push([
            contract.id,
            JSON.stringify(contract.name),
            payment.id,
            String(payment.amount),
            payment.status,
            payment.paidDate ? new Date(payment.paidDate).toISOString().slice(0, 10) : ''
          ].join(','));
        });
      }
    });

    const csv = [headers.join(','), ...lines].join('\n');
    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
    const link = document.createElement('a');
    link.href = URL.createObjectURL(blob);
    link.download = `contracts_detailed_export_${new Date().toISOString().slice(0, 10)}.csv`;
    link.click();
    URL.revokeObjectURL(link.href);
  }
}
```

#### 2.2 Contract Form Service
```typescript
// src/app/application/services/contract/contract-form.service.ts
/**
 * @ai-context {
 *   "role": "Application/Service",
 *   "purpose": "合約表單服務-表單驗證與數據轉換",
 *   "constraints": ["表單邏輯", "驗證規則", "無業務邏輯"],
 *   "dependencies": ["ContractValidator", "ContractMapper"],
 *   "security": "medium",
 *   "lastmod": "2024-12-19"
 * }
 */

import { Injectable } from '@angular/core';
import { FormBuilder, FormGroup, Validators } from '@angular/forms';
import { Contract } from '../../../domain/entities/contract';

@Injectable({ providedIn: 'root' })
export class ContractFormService {
  constructor(private fb: FormBuilder) {}

  createContractForm(): FormGroup {
    return this.fb.group({
      name: ['', [Validators.required, Validators.minLength(3)]],
      contractor: ['', [Validators.required, Validators.minLength(2)]],
      client: ['', [Validators.required, Validators.minLength(2)]],
      startDate: ['', Validators.required],
      endDate: ['', Validators.required],
      totalValue: [0, [Validators.required, Validators.min(0)]],
      scope: ['', [Validators.required, Validators.minLength(10)]],
      status: ['Active', Validators.required]
    });
  }

  createPaymentForm(): FormGroup {
    return this.fb.group({
      amount: [0, [Validators.required, Validators.min(0)]],
      description: ['', Validators.required],
      requestDate: ['', Validators.required],
      invoiceNumber: [''],
      status: ['Pending', Validators.required]
    });
  }

  createChangeOrderForm(): FormGroup {
    return this.fb.group({
      title: ['', [Validators.required, Validators.minLength(3)]],
      description: ['', [Validators.required, Validators.minLength(10)]],
      cost: [0, [Validators.required, Validators.min(0)]],
      scheduleDays: [0, [Validators.required, Validators.min(0)]],
      date: ['', Validators.required]
    });
  }

  validateContractForm(form: FormGroup): boolean {
    if (form.invalid) return false;

    const startDate = new Date(form.get('startDate')?.value);
    const endDate = new Date(form.get('endDate')?.value);

    if (endDate <= startDate) {
      form.get('endDate')?.setErrors({ invalidEndDate: true });
      return false;
    }

    return true;
  }
}
```

### 3. Use Cases 新增文件

#### 3.1 Create Contract Use Case
```typescript
// src/app/application/use-cases/contract/create-contract.use-case.ts
/**
 * @ai-context {
 *   "role": "Application/UseCase",
 *   "purpose": "創建合約用例-合約創建業務邏輯",
 *   "constraints": ["單一用例職責", "事務邊界", "輸入驗證"],
 *   "dependencies": ["ContractRepository", "ContractValidator"],
 *   "security": "high",
 *   "lastmod": "2024-12-19"
 * }
 */

import { Injectable } from '@angular/core';
import { ContractRepository } from '../../../domain/repositories/contract.repository';
import { Contract } from '../../../domain/entities/contract';

export interface CreateContractRequest {
  name: string;
  contractor: string;
  client: string;
  startDate: Date;
  endDate: Date;
  totalValue: number;
  scope: string;
}

@Injectable({ providedIn: 'root' })
export class CreateContractUseCase {
  constructor(private contractRepository: ContractRepository) {}

  async execute(request: CreateContractRequest): Promise<Contract> {
    // 驗證輸入
    this.validateRequest(request);

    // 創建合約實體
    const contract = Contract.create({
      name: request.name,
      contractor: request.contractor,
      client: request.client,
      startDate: request.startDate,
      endDate: request.endDate,
      totalValue: request.totalValue,
      status: 'Active',
      scope: request.scope,
      payments: [],
      changeOrders: [],
      versions: [{
        version: 1,
        date: new Date(),
        changeSummary: '初始版本'
      }]
    });

    // 保存到倉儲
    await this.contractRepository.save(contract);
    return contract;
  }

  private validateRequest(request: CreateContractRequest): void {
    if (!request.name || request.name.trim().length < 3) {
      throw new Error('合約名稱至少需要3個字符');
    }

    if (!request.contractor || request.contractor.trim().length < 2) {
      throw new Error('承包商名稱至少需要2個字符');
    }

    if (!request.client || request.client.trim().length < 2) {
      throw new Error('客戶名稱至少需要2個字符');
    }

    if (request.startDate >= request.endDate) {
      throw new Error('結束日期必須晚於開始日期');
    }

    if (request.totalValue <= 0) {
      throw new Error('合約總值必須大於0');
    }

    if (!request.scope || request.scope.trim().length < 10) {
      throw new Error('工作範疇至少需要10個字符');
    }
  }
}
```

### 4. Interface Layer 新增文件

#### 4.1 Contract Form Dialog Component
```typescript
// src/app/interface/components/contracts/contract-form-dialog.component.ts
/**
 * @ai-context {
 *   "role": "Interface/Component",
 *   "purpose": "合約表單對話框組件-合約新增/編輯界面",
 *   "constraints": ["組件複用性", "表單驗證", "響應式設計"],
 *   "dependencies": ["ContractFormService", "CreateContractUseCase"],
 *   "security": "medium",
 *   "lastmod": "2024-12-19"
 * }
 */

import { Component, Inject, OnInit } from '@angular/core';
import { CommonModule } from '@angular/common';
import { ReactiveFormsModule } from '@angular/forms';
import { MatDialogRef, MAT_DIALOG_DATA, MatDialogModule } from '@angular/material/dialog';
import { MatFormFieldModule } from '@angular/material/form-field';
import { MatInputModule } from '@angular/material/input';
import { MatButtonModule } from '@angular/material/button';
import { MatDatepickerModule } from '@angular/material/datepicker';
import { MatSelectModule } from '@angular/material/select';
import { ContractFormService } from '../../../application/services/contract/contract-form.service';
import { CreateContractUseCase } from '../../../application/use-cases/contract/create-contract.use-case';
import { Contract } from '../../../domain/entities/contract';

@Component({
  selector: 'app-contract-form-dialog',
  standalone: true,
  imports: [
    CommonModule,
    ReactiveFormsModule,
    MatDialogModule,
    MatFormFieldModule,
    MatInputModule,
    MatButtonModule,
    MatDatepickerModule,
    MatSelectModule
  ],
  template: `
    <h2 mat-dialog-title>{{ isEditMode ? '編輯合約' : '新增合約' }}</h2>

    <form [formGroup]="contractForm" (ngSubmit)="onSubmit()">
      <mat-dialog-content>
        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>合約名稱</mat-label>
            <input matInput formControlName="name" placeholder="輸入合約名稱">
            <mat-error *ngIf="contractForm.get('name')?.hasError('required')">
              合約名稱為必填項
            </mat-error>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>承包商</mat-label>
            <input matInput formControlName="contractor" placeholder="輸入承包商名稱">
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>客戶</mat-label>
            <input matInput formControlName="client" placeholder="輸入客戶名稱">
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>開始日期</mat-label>
            <input matInput [matDatepicker]="startPicker" formControlName="startDate">
            <mat-datepicker-toggle matSuffix [for]="startPicker"></mat-datepicker-toggle>
            <mat-datepicker #startPicker></mat-datepicker>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>結束日期</mat-label>
            <input matInput [matDatepicker]="endPicker" formControlName="endDate">
            <mat-datepicker-toggle matSuffix [for]="endPicker"></mat-datepicker-toggle>
            <mat-datepicker #endPicker></mat-datepicker>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline">
            <mat-label>合約總值</mat-label>
            <input matInput type="number" formControlName="totalValue" placeholder="輸入合約總值">
            <span matSuffix>元</span>
          </mat-form-field>

          <mat-form-field appearance="outline">
            <mat-label>狀態</mat-label>
            <mat-select formControlName="status">
              <mat-option value="Active">進行中</mat-option>
              <mat-option value="Completed">已完成</mat-option>
              <mat-option value="On Hold">暫停</mat-option>
              <mat-option value="Terminated">終止</mat-option>
            </mat-select>
          </mat-form-field>
        </div>

        <div class="form-row">
          <mat-form-field appearance="outline" class="full-width">
            <mat-label>工作範疇</mat-label>
            <textarea matInput formControlName="scope" rows="3" placeholder="描述工作範疇"></textarea>
          </mat-form-field>
        </div>
      </mat-dialog-content>

      <mat-dialog-actions align="end">
        <button mat-button type="button" (click)="onCancel()">取消</button>
        <button mat-raised-button color="primary" type="submit" [disabled]="contractForm.invalid || loading">
          {{ isEditMode ? '更新' : '創建' }}
        </button>
      </mat-dialog-actions>
    </form>
  `,
  styles: [`
    .form-row {
      display: flex;
      gap: 1rem;
      margin-bottom: 1rem;
    }

    .full-width {
      width: 100%;
    }

    mat-form-field {
      flex: 1;
    }

    .form-row:last-child {
      margin-bottom: 0;
    }
  `]
})
export class ContractFormDialogComponent implements OnInit {
  contractForm = this.contractFormService.createContractForm();
  loading = false;
  isEditMode = false;

  constructor(
    private dialogRef: MatDialogRef<ContractFormDialogComponent>,
    @Inject(MAT_DIALOG_DATA) public data: { contract?: Contract },
    private contractFormService: ContractFormService,
    private createContractUseCase: CreateContractUseCase
  ) {
    this.isEditMode = !!data.contract;
  }

  ngOnInit(): void {
    if (this.isEditMode && this.data.contract) {
      this.populateForm(this.data.contract);
    }
  }

  async onSubmit(): Promise<void> {
    if (this.contractForm.invalid) return;

    this.loading = true;
    try {
      if (this.isEditMode) {
        // TODO: 實現更新邏輯
        console.log('更新合約:', this.contractForm.value);
      } else {
        const result = await this.createContractUseCase.execute(this.contractForm.value);
        this.dialogRef.close(result);
      }
    } catch (error) {
      console.error('操作失敗:', error);
      // TODO: 顯示錯誤訊息
    } finally {
      this.loading = false;
    }
  }

  onCancel(): void {
    this.dialogRef.close();
  }

  private populateForm(contract: Contract): void {
    this.contractForm.patchValue({
      name: contract.name,
      contractor: contract.contractor,
      client: contract.client,
      startDate: contract.startDate,
      endDate: contract.endDate,
      totalValue: contract.totalValue,
      status: contract.status,
      scope: contract.scope
    });
  }
}
```

## 🚀 實現順序建議

### 第一階段：核心功能（1-2週）
1. 實現 Payment、ChangeOrder、ContractVersion 實體
2. 實現 ContractExportService（CSV 匯出）
3. 實現 ContractFormService（表單驗證）
4. 實現 CreateContractUseCase（創建合約）

### 第二階段：UI 組件（2-3週）
1. 實現 ContractFormDialogComponent（合約表單）
2. 實現 PaymentManagementComponent（付款管理）
3. 實現 ChangeOrderManagementComponent（變更單管理）
4. 更新現有組件以支援新功能

### 第三階段：整合與優化（1-2週）
1. 整合所有新組件到主頁面
2. 實現權限控制
3. 優化用戶體驗
4. 添加錯誤處理和驗證

## 📊 預期效果

### 功能完整性
- **合約管理**: 100% 完整
- **付款追蹤**: 100% 完整
- **變更單管理**: 100% 完整
- **CSV 匯出**: 100% 完整

### 技術指標
- **DDD 架構**: 嚴格遵循
- **Angular 20**: 現代特性
- **響應式設計**: 完整支援
- **錯誤處理**: 全面覆蓋

## 💡 注意事項

1. **檔案標頭**: 所有新文件必須包含 AI 優化檔案標頭
2. **類型安全**: 嚴格使用 TypeScript 類型
3. **錯誤處理**: 實現完整的錯誤處理機制
4. **用戶體驗**: 注重響應式設計和無障礙性
5. **測試覆蓋**: 為關鍵功能添加單元測試

這個實現計畫將確保合約功能達到企業級標準，提供完整的合約生命週期管理能力。

---

## 🎯 完整功能重現計畫總結

### 📋 已完成的規劃更新

#### 1. 核心功能擴展 ✅
- **專案管理系統**: 專案儀表板、專案列表、專案詳情、任務樹、狀態管理、價值分配
- **合約管理系統**: 多標籤頁詳情、付款進度追蹤、變更單影響分析、版本歷史時間軸
- **AI 功能系統**: AI 合約摘要、AI 子任務建議、文件處理與分析
- **權限控制系統**: 用戶認證授權、角色基礎權限控制

#### 2. 技術要求升級 ✅
- 整合 Angular Material 20 最新組件
- 使用 Angular 20 的 Signals 和 Control Flow
- 實現現代化的狀態管理
- 支援 AI 功能整合

#### 3. 完整文件結構規劃 ✅
- **Domain Layer**: 新增 `project/` 實體和 `project.repository.ts`
- **Application Layer**: 新增專案相關 DTOs、Services、Use Cases、Validators
- **Infrastructure Layer**: 新增專案儲存庫和 AI 子任務生成服務
- **Interface Layer**: 新增專案頁面、任務組件、共享組件
- **Shared Layer**: 新增專案類型、計算工具、國際化支援

### 🚀 下一步實施建議

#### 第一階段：專案管理核心（2-3週）
1. **實體層實現**
   - 實現 `Project` 和 `Task` 實體
   - 實現 `ProjectRepository` 介面
   - 建立專案和任務的領域服務

2. **應用層實現**
   - 實現專案相關 DTOs
   - 實現專案應用服務
   - 實現專案用例（創建、更新、刪除、任務管理）

3. **基礎設施層實現**
   - 實現 Firebase 專案儲存庫
   - 實現 AI 子任務生成服務

#### 第二階段：UI 組件開發（3-4週）
1. **專案頁面**
   - 實現 `DashboardPage` 和專案統計
   - 實現 `ProjectsListPage` 和專案列表
   - 實現 `ProjectDetailPage` 和任務樹

2. **專案組件**
   - 實現 `ProjectProgressChart` 進度圖表
   - 實現 `ProjectListItem` 專案列表項
   - 實現 `CreateProjectDialog` 創建對話框

3. **任務組件**
   - 實現 `TaskItem` 任務項組件
   - 實現 `TaskTree` 任務樹組件
   - 實現 `AiSubtaskSuggestions` AI 建議組件

#### 第三階段：合約功能增強（2-3週）
1. **合約詳情增強**
   - 實現多標籤頁詳情展示
   - 實現付款進度追蹤組件
   - 實現變更單影響分析組件
   - 實現版本歷史時間軸組件

2. **AI 功能整合**
   - 整合 AI 合約摘要服務
   - 整合 AI 子任務建議服務
   - 實現文件處理與分析

#### 第四階段：整合與優化（2-3週）
1. **系統整合**
   - 整合專案和合約功能
   - 實現統一的導航和路由
   - 實現響應式設計

2. **性能優化**
   - 實現懶加載和代碼分割
   - 優化資料查詢和快取
   - 實現虛擬滾動和分頁

3. **用戶體驗**
   - 實現無障礙設計
   - 添加動畫和過渡效果
   - 實現深色主題支援

### 📊 預期最終效果

#### 功能完整性
- **專案管理**: 100% 完整重現 NextJS 功能
- **合約管理**: 100% 完整重現 NextJS 功能
- **AI 功能**: 100% 完整重現 NextJS 功能
- **用戶體驗**: 超越 NextJS 的現代化 Angular 實現

#### 技術指標
- **DDD 架構**: 嚴格遵循，優於 NextJS 的簡單結構
- **Angular 20**: 使用最新特性，包括 Signals 和 Control Flow
- **Angular Material 20**: 現代化 UI 組件庫
- **響應式設計**: 完整支援各種設備
- **錯誤處理**: 全面的錯誤處理和用戶反饋
- **測試覆蓋**: 高測試覆蓋率確保品質

### 💡 關鍵實施要點

1. **架構一致性**: 嚴格遵循現有的 DDD 架構和 `06-folder-structure-current.md` 規範
2. **現代化技術**: 充分利用 Angular 20 和 Material 20 的最新特性
3. **AI 整合**: 確保 AI 功能與業務邏輯的完美整合
4. **性能優化**: 實現高效的資料處理和 UI 渲染
5. **用戶體驗**: 注重直觀的操作流程和視覺設計
6. **國際化**: 支援多語言，特別是中文繁體和英文

這個擴展計畫將確保 Angular 專案完美重現 NextJS 專案的所有功能，同時利用 Angular 20 的現代特性提供更好的開發體驗和用戶體驗。
