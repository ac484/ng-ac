## PartnerVerse (Next.js) 功能盤點與 Angular 現代化重現方案

### 功能盤點（來自 `e/PartnerVerse-main/`）
- **導航與視圖**：`Dashboard`、`Partners`、`Workflows` 三分頁，側邊欄切換（`AppSidebar`）、頂部列（角色切換/動作）（`Header`）。
- **夥伴管理（Partners）**：
  - 清單、搜尋、依狀態/分類過濾（`PartnerList`）
  - 建立/編輯表單與驗證（`PartnerForm` + Zod）
  - 詳情頁含分頁籤：Overview、Performance、Compliance、Contracts、Contacts、Transactions（`PartnerProfile`）
  - Firestore 持久化：`partners` 集合（`addDoc/setDoc`）
  - 通知（`useToast`）
- **儀表板（Dashboard）**：
  - 總覽卡片、類別柱狀圖（Recharts）、近期動態卡
  - Skeleton 載入狀態
- **流程管理（Workflows）**：
  - 視覺化流程編輯器：節點拖曳、邊連線、雙擊節點編輯、刪除節點（`WorkflowBuilder`）
  - 與夥伴關聯、建立新流程、Firestore `workflows` 集合
  - AI 最佳化助理（`OptimizationAssistant` → `ai/flows/workflow-optimization` with Genkit/Gemini）
- **基礎設施**：
  - Firestore 用戶端（`lib/firebase.ts`）
  - AI（Genkit、GoogleAI 插件）

#### UI 元件庫與工具（完整枚舉）
- 通用元件：`button`, `card`, `badge`, `input`, `textarea`, `select`, `checkbox`, `radio-group`, `switch`, `tabs`, `table`, `dialog`, `alert-dialog`, `dropdown-menu`, `popover`, `tooltip`, `sheet`（抽屜）, `accordion`, `carousel`, `progress`, `separator`, `skeleton`, `avatar`
- 圖表封裝：`components/ui/chart.tsx`（Tooltip/Legend/Style 包裝 Recharts）
- 側邊欄複合元件：`components/ui/sidebar.tsx`（含 Provider/Trigger/Menu 等）
- 工具：`hooks/use-toast.ts`（全域 toast store）、`lib/utils.ts`（`cn()` Tailwind 合併）

### 資料模型對照
- `Partner`：`id?`, `name`, `logoUrl`, `category`, `status`, `overview`, `website`, `contacts[]`, `transactions[]`, `joinDate`, `performanceReviews[]`, `complianceDocuments[]`, `contracts[]`
- `Workflow`：`id?`, `name`, `nodes[{ id,type:'start'|'end'|'task'|'decision',label,position{x,y} }]`, `edges[{ id,source,target,label? }]`, `partnerId?`

---

### Angular 20 現代化重現策略（DDD 對照）

1) 導航與頁面框架（Interface/Page + Layout）
- 路由：`app.routes.ts` 加入 `dashboard`, `partners`, `workflows` 三頁。
- 側邊欄與頂部列：
  - `interface/layouts/main-app` 新增 `AppSidebarComponent`, `HeaderComponent`
  - 使用 Signals 管理目前視圖、角色；模板採用 `@for/@if`。

2) 夥伴管理（Partners）
- Domain
  - `domain/entities/partner/partner.entity.ts`：以不可變結構與建構工廠保障有效狀態。
  - `domain/repositories/partner.repository.ts`：宣告倉儲介面（`findAll`, `save`, `update`, `findById`）。
- Application
  - UseCases：`list-partners.use-case.ts`、`create-partner.use-case.ts`、`update-partner.use-case.ts`、`get-partner.use-case.ts`
  - DTO/Validators：沿用 Zod 規則等價於 Angular Form 驗證器；或以 `zod` + `@ngx-validate`/自訂 adapter。
- Infrastructure
  - `infrastructure/persistence/firebase/partner.repository.impl.ts`
    - 使用 AngularFire（或 Web SDK）操作 `partners` 集合（型別安全 + 錯誤轉換）。
- Interface
  - `interface/pages/partners/list`：清單、搜尋、過濾（轉為 Signals + `@for`）；
  - `interface/pages/partners/detail`：分頁籤切換（Material Tabs 或自建），呈現 Performance/Compliance/Contracts 等；
  - `interface/components/partners/partner-form`：Standalone + Reactive Forms；表單錯誤即時顯示；`@defer` 延遲非關鍵區塊；
  - 通知：`shared/services/toast.service.ts` 封裝 `MatSnackBar`。

3) 儀表板（Dashboard）
- 圖表：改用 `ng-apexcharts` 或 `ngx-echarts`；封裝為 `shared/components/charts/bar-chart`。
- 統計卡：`shared/components/widgets/stat-card`；
- Skeleton：`shared/components/skeleton`；
- 資料來源：`application/services/partners-analytics.service.ts` 對 `Partner[]` 做彙整（總數、分類分布、交易總數）。

4) 流程管理（Workflows）
- Domain
  - `domain/entities/workflow/workflow.entity.ts`、`workflow-node.vo.ts`、`workflow-edge.vo.ts`
  - `domain/repositories/workflow.repository.ts`
- Application
  - UseCases：`list-workflows.use-case.ts`、`create-workflow.use-case.ts`、`update-workflow.use-case.ts`
- Infrastructure
  - `infrastructure/persistence/firebase/workflow.repository.impl.ts` 對 `workflows` 集合 CRUD。
- Interface
  - `interface/pages/workflows/builder`
    - 畫布：SVG + Angular 模板（`@for`）繪製邊與節點；
    - 拖曳：Angular CDK DragDrop 取代自寫滑鼠事件；
    - 編輯對話框：Material Dialog；
    - 與夥伴關聯：下拉 + 寫回 UseCase。

5) AI 最佳化助理（Optimization Assistant）
- Infrastructure/External
  - `infrastructure/external-services/ai/optimization.service.ts`
  - 從前端呼叫一個後端/雲函式 HTTP 端點（包裝 Next/Genkit 流程，或以 Cloud Functions 直接部署）。
- Interface
  - `interface/components/workflows/optimization-assistant`：表單 + 請求/結果狀態（Signals）。

6) 安全與設定
- 環境變數：`infrastructure/config/environment.service.ts` 提供 `FIREBASE_*` 設定；
- 權限（選配）：`infrastructure/security/rbac.service.ts` 以角色（Admin/Manager/Viewer）切換 UI 能力。

7) UI 元件映射（Next.js → Angular）
- 表單/輸入：Next `input/textarea/select/checkbox/radio/switch` → Angular Material `MatFormField` + `MatInput`/`MatSelect`/`MatCheckbox`/`MatRadio`/`MatSlideToggle` 或維持 Tailwind + 自建 `shared/components/form/*`
- 對話框/抽屜：`dialog/alert-dialog/sheet` → `MatDialog` + 自建 `DrawerComponent`
- 功能表：`dropdown-menu/popover/tooltip` → `MatMenu`/`MatTooltip` 或 `cdkOverlay`
- 分頁籤/表格：`tabs/table` → `MatTabs`/`MatTable` 或自建輕量元件
- 卡片/徽章/骨架：`card/badge/skeleton` → `MatCard` + 自建 `BadgeComponent`/`SkeletonComponent`
- 圖表：Recharts → `ng-apexcharts`（或 `ngx-echarts`）並以 `shared/components/charts/*` 封裝 Tooltip/Legend/Style
- 側邊欄：`ui/sidebar.tsx` → Angular CDK + Tailwind/Material Sidenav 封裝為 `shared/components/layout/app-sidebar`
- Toast：`hooks/use-toast` → `shared/services/toast.service.ts`（`MatSnackBar` 或自建 Overlay）

---

### 路由結構建議
```ts
// app.routes.ts（摘要）
export const routes: Routes = [
  { path: '', pathMatch: 'full', redirectTo: 'dashboard' },
  { path: 'dashboard', loadComponent: () => import('.../pages/dashboard').then(m => m.DashboardPage) },
  { path: 'partners', children: [
      { path: '', loadComponent: () => import('.../pages/partners/list').then(m => m.PartnersListPage) },
      { path: ':id', loadComponent: () => import('.../pages/partners/detail').then(m => m.PartnerDetailPage) },
  ]},
  { path: 'workflows', loadComponent: () => import('.../pages/workflows/builder').then(m => m.WorkflowBuilderPage) },
];
```

---

### Angular 20 現代化要點落地
- 狀態管理：以 `signal/computed/effect` 取代多餘 RxJS；清單/過濾/表單狀態皆以 Signals。
- 控制流程：模板全面使用 `@if/@for`；
- 效能：`@defer` 延遲重；長清單以 CDK Virtual Scroll；
- UI：Material 3 或 Tailwind（專案已支持 SCSS，可雙軌進行）；
- 可用性：Skeleton、空狀態、錯誤提示統一風格；
- 類型安全：資料層以 DTO + Mapper，基礎設施層負責轉換 Firestore Document。

---

### Firestore 與環境設定
- Collections：`partners`、`workflows`
- AngularFire 設定：
  - `environments/environment.ts` 內提供 `firebase: {...}`，由 `EnvironmentService` 暴露；
  - `infrastructure/persistence/firebase/*repository.impl.ts` 透過 AngularFire `Firestore` 操作，封裝錯誤與重試策略；
  - 型別轉換：Repository 負責將 Document 轉為 Domain Entity/DTO（日期/金額等正規化）。

---

### 目錄與檔案建議（關鍵增量）
- `domain/entities/partner/partner.entity.ts`
- `domain/repositories/partner.repository.ts`
- `application/use-cases/partners/{list,create,update,get}.use-case.ts`
- `infrastructure/persistence/firebase/{partner.repository.impl.ts, workflow.repository.impl.ts}`
- `interface/pages/partners/{list,detail}`、`interface/pages/workflows/builder`
- `interface/components/partners/partner-form`
- `shared/components/{widgets/stat-card, charts/bar-chart, skeleton}`
- `infrastructure/external-services/ai/optimization.service.ts`

---

### 迭代實施路線
1. 基礎設施接通：AngularFire（或 SDK）+ `EnvironmentService`
2. Partner 清單/表單（Signals + Reactive Forms）→ 詳情頁分頁籤
3. Dashboard 圖表與統計卡
4. Workflow Builder（SVG + CDK DragDrop）與 CRUD
5. AI 助理 HTTP 串接與 UI

---

### 最小可行切片（MVP 驗收）
- 能從 Firestore 讀/寫 `partners`、`workflows`
- `Partners` 清單搜尋/過濾、建立/編輯；`Partner` 詳情分頁籤
- `Dashboard` 4 張統計卡 + 1 張柱狀圖
- `Workflow` 新增流程、拖曳節點、建立/刪除邊、保存
- `AI 助理` 送出表單並顯示結果/錯誤

---

### 技術選型備註
- 圖表：`ng-apexcharts` 或 `ngx-echarts` 擇一；
- 通知：`MatSnackBar` 或自建 Toast（`shared/services/toast.service.ts`）。
- 表單驗證：以 Angular 表單驗證為主，允許以 Zod 做 schema 校驗（開發體驗佳）。

以上規劃可無痛對齊現有 DDD 結構，漸進替換與擴展，同時引入 Angular 20 現代能力（Signals、@if/@for、CDK、@defer）。

---

## 交互順序與詳細實現

### 全域初始化流程
- App 啟動 → `EnvironmentService` 載入 Firebase 設定 → 初始化 Firestore 客戶端
- Layout 載入 `AppSidebarComponent`、`HeaderComponent`（角色 Signals）
- 路由至對應頁面 → 掛載頁面層 Service（Signals 初始化）

### Dashboard（互動順序）
1. 載入夥伴列表（UseCase：ListPartners）→ Signals：`partners`、`isLoading`
2. 計算統計（`computed`）：總夥伴數、Active/Pending、交易總數、分類聚合
3. 顯示 Skeleton → 完成載入後呈現卡片與圖表
4. 點擊「View All Partners」→ 導向 `partners`

Angular 實現要點：
- `DashboardPage` 以 `computed` 產生圖表資料；圖表元件用 `ng-apexcharts` + `@defer` 延遲載入
- UI 以 `@if` 切換 loading/實際內容

### Partners List（互動順序）
1. 初始：呼叫 ListPartners → `partners`、`isLoading`
2. 使用者輸入搜尋詞、選擇狀態/分類 → `searchTerm/status/category` Signals
3. `filteredPartners = computed(...)` 依輸入即時過濾
4. 點擊卡片 → 導向 `partners/:id`
5. 按下「Add Partner」（Admin/Manager）→ 開啟表單 Dialog

儲存流程：
- 表單提交 → `CreatePartner` 或 `UpdatePartner` → Repository `addDoc/setDoc`
- 成功：更新本地 `partners` Signal、關閉對話框、Toast 成功
- 失敗：Toast 錯誤

Angular 實現要點：
- Reactive Forms + 同步/非同步驗證；`pending` 狀態綁定 `disabled`
- 過濾以 `computed` 實作；列表使用 `@for`，空狀態友善提示
- Toast 透過 `toast.service` 統一

### Partner Detail（互動順序）
1. 進入 `partners/:id` → 讀取 Partner，Signals：`partner`, `isLoading`
2. Tabs：Overview/Performance/Compliance/Contracts/Contacts/Transactions
3. 編輯：按下「Edit Partner」→ 開啟表單 Dialog → 保存流程同上

Angular 實現要點：
- Tabs：Material Tabs 或自建；各區塊拆成子組件（Standalone）
- 日期/金額格式化：Pipe 或 `Intl`
- 文件/合約清單用 `MatTable` 或輕量 table 元件

### Workflows Builder（互動順序）
1. 讀取 `workflows` → `workflows`, `selectedWorkflow`, `isLoading`
2. 下拉選單切換 Workflow；或「New Workflow」建立預設起訖節點
3. 於畫布拖曳節點（CDK DragDrop）→ 即時更新節點座標 Signals
4. 雙擊節點 → 開啟編輯對話框：
   - 修改 label
   - 建立新 Edge：選擇 target + 可選 label
   - 刪除節點：同時移除關聯邊
5. 指派 Partner（下拉），按「Save Changes」→ 更新至 Firestore

Angular 實現要點：
- 畫布：容器元素 + 絕對定位節點；Edges 以 SVG path 繪製（`marker-end` 箭頭）
- 拖曳：`CdkDrag` 限定在畫布內；拖動事件節流 + `runOutsideAngular` 提升效能
- 邊重新繪製：`computed` 依節點座標推導 path；
- 對話框：`MatDialog` + 表單；刪除節點時同步清理邊

### AI Optimization Assistant（互動順序）
1. 使用者填寫「Historical Transaction Data」與「Current Workflow Definition」
2. Submit → 設為 loading，顯示 Skeleton；呼叫後端 AI 端點
3. 成功：顯示 `suggestedOptimizations`、`predictedEfficiencyIncrease`、`rationale`
4. 失敗：顯示 Error 卡片

Angular 實現要點：
- `optimization-assistant.component.ts`：Signals 管理 `formData/result/error/isLoading`
- 端點：`OptimizationService.suggest(input)`（HTTP 呼叫雲函式），擴充重試與錯誤對映
- UI 動畫：Tailwind/Material 動畫 + `@defer`

### 導航與角色切換
- 側邊欄按鈕切換視圖 → Router 導航
- Header 角色下拉（Admin/Manager/Viewer）→ Signals → 控制按鈕可見性/可用性

---

## 關鍵程式片段（參考）

```ts
// Partners 過濾（Signals）
const partners = signal<Partner[]>([])
const searchTerm = signal('')
const statusFilter = signal<'All'|'Active'|'Inactive'|'Pending'>('All')
const categoryFilter = signal<'All'|Partner['category']>('All')

const filteredPartners = computed(() => {
  const term = searchTerm().toLowerCase()
  return partners().filter(p =>
    (p.name.toLowerCase().includes(term) || p.overview.toLowerCase().includes(term)) &&
    (statusFilter()==='All' || p.status===statusFilter()) &&
    (categoryFilter()==='All' || p.category===categoryFilter())
  )
})
```

---

## 依據當前專案目錄的落地方案與完整文件樹
（對齊 `docs/0.FOLDER_STRUCTURE_NOW.md` 的 DDD 分層與 `src/app` 架構）

### 落地步驟（建議執行順序）
1. 接通基礎設施：環境設定、AngularFire/Firestore 初始化、Repository 介面與 Firebase 實作
2. Partners：清單/過濾、表單、詳情分頁籤；完成 UseCases + Pages + Components
3. Dashboard：統計計算服務 + 圖表/卡片元件
4. Workflow Builder：畫布、拖曳、節點/邊編輯、保存
5. AI 助理：HTTP 端點串接 + 表單/結果顯示

### 新增/調整文件樹（提案）
```text
src/app/
  domain/
    entities/
      partner/
        partner.entity.ts
        partner-contact.entity.ts
        partner-contract.entity.ts
      workflow/
        workflow.entity.ts
    value-objects/
      workflow-node.vo.ts
      workflow-edge.vo.ts
    repositories/
      partner.repository.ts
      workflow.repository.ts

  application/
    dto/
      partners/
        partner.dto.ts
      workflows/
        workflow.dto.ts
    use-cases/
      partners/
        list-partners.use-case.ts
        get-partner.use-case.ts
        create-partner.use-case.ts
        update-partner.use-case.ts
      workflows/
        list-workflows.use-case.ts
        create-workflow.use-case.ts
        update-workflow.use-case.ts
    services/
      partners/
        partners-analytics.service.ts
      workflows/
        workflow-coordinator.service.ts
    validators/
      partners/
        partner.validator.ts
      workflows/
        workflow.validator.ts

  infrastructure/
    persistence/
      firebase/
        converters/
          partner.converter.ts
          workflow.converter.ts
        partner.repository.impl.ts
        workflow.repository.impl.ts
    external-services/
      ai/
        optimization.service.ts

  interface/
    pages/
      dashboard/
        dashboard.page.ts
      partners/
        list/
          partners-list.page.ts
        detail/
          partner-detail.page.ts
      workflows/
        builder/
          workflow-builder.page.ts
    components/
      partners/
        partner-form.component.ts
        partner-card.component.ts
      workflows/
        workflow-canvas.component.ts
        workflow-node-dialog.component.ts

  shared/
    components/
      widgets/
        stat-card.component.ts
      charts/
        bar-chart.component.ts
    services/
      toast.service.ts

  app.routes.ts          # 新增 routes：dashboard/partners/workflows
```

### 路由調整（摘要）
```ts
// app.routes.ts（新增）
{ path: 'dashboard', loadComponent: () => import('./interface/pages/dashboard/dashboard.page').then(m => m.DashboardPage) },
{ path: 'partners', children: [
  { path: '', loadComponent: () => import('./interface/pages/partners/list/partners-list.page').then(m => m.PartnersListPage) },
  { path: ':id', loadComponent: () => import('./interface/pages/partners/detail/partner-detail.page').then(m => m.PartnerDetailPage) }
]},
{ path: 'workflows', loadComponent: () => import('./interface/pages/workflows/builder/workflow-builder.page').then(m => m.WorkflowBuilderPage) },
```

### MVP 驗收（與文件樹對應）
- Partners：清單/搜尋/過濾、建立/編輯、詳情分頁籤（Repository + UseCases + Pages/Components）
- Dashboard：4 張統計卡 + 1 張柱狀圖（`partners-analytics.service.ts` + widgets/charts）
- Workflows：建立/選擇/拖曳/連線/刪除/保存（SVG + CDK）
- AI 助理：表單送出 → 顯示建議/效率預估/理由（`optimization.service.ts`）

以上文件樹可分支逐步落地，先完成 Partners 與 Dashboard 再導入 Workflows 與 AI，確保風險可控與快速可見成果。


```ts
// Repository 介面（摘要）
export interface PartnerRepository {
  findAll(): Promise<Partner[]>
  findById(id: string): Promise<Partner | null>
  save(partner: Partner): Promise<string> // returns id
  update(id: string, partner: Omit<Partner,'id'>): Promise<void>
}
```

```ts
// Firestore 實作（摘要）
class FirestorePartnerRepository implements PartnerRepository {
  async findAll() { /* collectionData('partners') 轉 Domain */ }
  async findById(id: string) { /* doc('partners', id) */ }
  async save(p: Partner) { /* addDoc('partners') */ }
  async update(id: string, p: Omit<Partner,'id'>) { /* setDoc merge */ }
}
```

