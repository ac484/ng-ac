## Constructo 專案/任務功能對照與 Angular 20 重現方案

### 功能地圖（Next.js 專案觀察）
- 導覽與版型
  - 側邊欄：`Dashboard`、`Projects`、`Contracts`
  - 版型 `ProjectProvider` 供應專案資料
- Dashboard（/dashboard）
  - 指標卡片：專案數、任務總數、已完成數
  - 即將到期專案清單（30 天內）
  - 每個專案進度圖（Recharts Pie，以任務 value 加總計算完成比例）
- Projects 清單（/projects）
  - 新增專案對話框（表單驗證：標題、描述、總值、起迄日期，結束>開始）
  - 卡片呈現每個專案：描述、期間、完成百分比（以 leaf 任務 value 計算）
- Project 詳情（/projects/[id]）
  - 任務樹（可展開/收合）
  - 任務狀態切換（Pending/In Progress/Completed）
  - 新增任務/子任務（數量 x 單價 = value；不可超過剩餘 value）
  - AI 子任務建議（以主任務標題 + 專案標題呼叫 Genkit Flow）

### 資料模型（Next 版本參考）
```ts
export type TaskStatus = 'Pending' | 'In Progress' | 'Completed';

export interface Task {
  id: string;
  title: string;
  status: TaskStatus;
  lastUpdated: string;
  subTasks: Task[];
  value: number;       // quantity * unitPrice
  quantity: number;
  unitPrice: number;
}

export interface Project {
  id: string;
  title: string;
  description: string;
  startDate: Date;
  endDate: Date;
  tasks: Task[];
  value: number;       // 專案總值（用以控制任務分配）
}
```

### Angular 20 現代化重現設計
- 路由（Interface/Page）
  - `/dashboard`、`/projects`、`/projects/:id` 對應 Standalone Components

- 組件（Interface/Component）
  - `project-progress-card`：Pie/Progress（可先用 Material Progress，或引入 ngx-charts）
  - `project-card`：列表卡片
  - `create-project-dialog`：表單（Reactive Forms + zod/yup 或 Angular Validators）
  - `task-item`：遞迴任務樹、狀態選擇、AI 建議、子任務表單

- 應用服務（Application/Service）
  - `ProjectApplicationService`：
    - signals 狀態：`projects`、`loading`
    - 查找、更新任務狀態、加入任務、建立專案
    - 計算統計（任務計數、完成度、即將到期）

- 資料存取（Infrastructure/Repository）
  - `ProjectRepository`（Domain 介面）與 `FirebaseProjectRepository`（Infra）
  - 任務更新/新增採不可變更新，保持純前端計算可測試性

- AI 整合（Infrastructure/External）
  - `TaskSuggestionService`：呼叫後端（Genkit Flow）取得子任務標題建議

- 狀態管理（Signals First）
  - `projects = signal<Project[]>([])`
  - `stats = computed(...)`、`deadlines = computed(...)`
  - `effect` 推動快取或持久化

### 任務價值分配與驗證
- 規則
  - 任務 value = quantity × unitPrice
  - 子任務加總不可超過父任務 value；頂層任務加總不可超過專案 value
- 實作
  - 新增任務時先計算剩餘可分配值（父節點/專案），若超過則阻擋並提示

### 頁面骨架（範例）
```ts
// src/app/interface/pages/projects/projects.page.ts
@Component({
  standalone: true,
  template: `
    <header class="flex items-center justify-between">
      <h1>Projects</h1>
      <app-create-project-dialog (created)="reload()" />
    </header>
    @if (loading()) { <app-skeleton-list /> } @else {
      <div class="grid">
        @for (p of projects(); track p.id) {
          <app-project-card [project]="p" />
        }
      </div>
    }
  `,
  imports: [CommonModule, CreateProjectDialogComponent, ProjectCardComponent],
})
export class ProjectsPage {
  private readonly app = inject(ProjectApplicationService);
  readonly projects = this.app.projects;
  readonly loading = this.app.loading;
  reload() { this.app.refresh(); }
}
```

### Application Service 核心（示意）
```ts
export class ProjectApplicationService {
  readonly projects = signal<Project[]>([]);
  readonly loading = signal<boolean>(false);

  addProject(input: Omit<Project, 'id' | 'tasks'>) { /* 呼叫 repo，更新 projects */ }
  updateTaskStatus(projectId: string, taskId: string, status: TaskStatus) { /* 遞迴更新 */ }
  addTask(projectId: string, parentTaskId: string | null, title: string, quantity: number, unitPrice: number) {
    // 計算剩餘值，驗證後插入
  }

  // 統計
  readonly totalTasks = computed(() => /* flatten 後計算 */ 0);
  readonly completedTasks = computed(() => 0);
  readonly upcomingDeadlines = computed(() => /* 30 天內 */ []);
}
```

### AI 子任務建議串接
- 前端傳入：`{ projectTitle, taskTitle }`
- 後端（建議）
  - 封裝 Genkit Flow（等同 Next 版 `generateSubtasksFlow`）
  - 回傳 3~5 筆建議標題，前端點選後自動新增子任務（預設數量=1、單價=min(10, 剩餘)）

### 與本專案 DDD 目錄對齊
- Domain：`domain/entities/project/*`、`domain/repositories/project.repository.ts`
- Application：`application/services/project/project-application.service.ts`
- Infrastructure：`infrastructure/persistence/repositories/project`、`infrastructure/external-services/ai/task-suggestion.service.ts`
- Interface：`interface/pages/projects`、`interface/components/projects/*`、`interface/pages/dashboard`

### 實作清單（建議順序）
1) 型別與 Repository（Domain）
2) 假資料/Firestore 實作（Infra）
3) Application Service + signals 計算
4) 頁面與組件（`@if/@for`、Material）
5) AI 建議服務與整合（後端 API）
6) 表單驗證、錯誤狀態與 Skeleton/Loading

---

### 互動順序與事件流（Dashboard → Projects → Project Detail）
1. Dashboard 載入
   - Service 請求 `ProjectRepository.list()` → `projects.set(data)`
   - `totalTasks/completedTasks/upcomingDeadlines` 經 `computed` 即時計算
   - 骨架 → 卡片 + 圖表（`@defer` 可延後圖表）
2. Projects 清單
   - 顯示卡片（進度% 以 leaf 任務 value 計算）
   - 點擊「New Project」→ 對話框 → 表單驗證（標題 >=3、描述 >=10、value >=1、endDate > startDate）→ `addProject()` → Toast 成功 → 關閉與重置
3. Project 詳情
   - 任務樹展開/收合（遞迴組件）
   - 狀態切換：`updateTaskStatus(projectId, taskId, status)`（更新 `lastUpdated`）
   - 新增子任務：輸入標題/數量/單價 → 計算 `value = q*price` → 驗證不可超過剩餘值 → 新增後清空表單並保持展開
   - AI 子任務：點擊 Sparkles → 取得建議（3~5）→ 使用者點「Add」直接以 `quantity=1`、`unitPrice=min(10, remaining)` 建立

### 計算邏輯與資料一致性
- 剩餘值（頂層）：`projectRemaining = project.value - sum(topLevelTask.value)`
- 剩餘值（任務）：`taskRemaining = task.value - sum(child.value)`
- 進度（專案）：`completedLeafValue / project.value`
- 進度（圖表）：以 leaf 任務 value 分類到 Completed/In Progress/Pending
- 更新狀態時只改葉節點進度計算（避免雙重計數）

```ts
function flattenTasks(tasks: Task[]): Task[] {
  return tasks.flatMap(t => [t, ...flattenTasks(t.subTasks || [])]);
}
```

### Angular 實作細節與最佳實踐
- Router：三頁皆 Standalone，啟用 `withViewTransitions()`；詳細頁可 `canMatch` 驗證存在的 `id`
- 表單：Reactive Forms + 同步驗證（結束日期大於開始日期）
- 狀態：`signal<Project[]>([])`、所有衍生資訊用 `computed`
- 表現層：`@if/@for` 控制流程、`cdk-virtual-scroll-viewport`（大量任務時）
- 效能：遞迴任務項使用 `OnPush` 與 `trackBy`（`task.id`）
- UX：Toast 成功/失敗、表單錯誤訊息、空態與骨架
- CSS：Container Queries（任務行內操作在小螢幕折行）

### Repository/Service 介面（精簡範例）
```ts
// domain/repositories/project.repository.ts
export interface ProjectRepository {
  list(): Promise<Project[]>;
  create(input: Omit<Project, 'id' | 'tasks'>): Promise<Project>;
  update(project: Project): Promise<void>;
}

// application/services/project/project-application.service.ts
export class ProjectApplicationService {
  constructor(private repo: ProjectRepository) {}
  readonly projects = signal<Project[]>([]);
  readonly loading = signal(false);
  async refresh() { this.loading.set(true); this.projects.set(await this.repo.list()); this.loading.set(false); }
  async addProject(input: Omit<Project, 'id' | 'tasks'>) { const created = await this.repo.create(input); this.projects.update(arr => [created, ...arr]); }
  // updateTaskStatus / addTask 同前述規則
}
```

### 錯誤處理與 UX 細節
- 建立專案：日期不合法、value 無效 → 即時錯誤提示
- 新增（子）任務：剩餘值不足 → 阻擋並顯示剩餘值提示
- AI 建議：失敗時允許重試；無建議時顯示空訊息
- 詳細頁找不到 `id`：導回列表並 Toast 提示

### 測試建議（最小集）
- Service：剩餘值/進度計算、任務狀態更新、加入任務的遞迴插入
- Form：日期交叉驗證、數字邊界
- UI：展開/狀態切換/AI 建議流程的互動測試

---

## 文件樹與落地方案（對齊目前目錄結構）
以下為「專案/任務」垂直功能完整落地的檔案樹，對齊 `src/app` 的 DDD 分層與現有目錄設計 [[memory:5079044]]。

```text
src/app/
  domain/
    entities/
      project/
        project.entity.ts
        task.entity.ts
        index.ts
    repositories/
      project.repository.ts

  application/
    dto/
      project/
        project.dto.ts
        task.dto.ts
        index.ts
    services/
      project/
        project-application.service.ts     // signals 狀態、建立/更新/統計
        project-progress.service.ts         // 完成度/期限等計算抽離
        index.ts
    use-cases/
      project/
        list-projects.use-case.ts
        create-project.use-case.ts
        update-task-status.use-case.ts
        add-task.use-case.ts
        index.ts
    validators/
      project/
        project-form.validator.ts           // 標題/描述/日期/value 驗證
        task-form.validator.ts              // 數量/單價/剩餘值驗證
        index.ts

  infrastructure/
    external-services/
      ai/
        task-suggestion.service.ts          // 呼叫後端 Genkit Flow
    persistence/
      repositories/
        project/
          firebase-project.repository.ts    // AngularFire/HTTP 實作
          in-memory-project.repository.ts   // 假資料/開發模式
          index.ts

  interface/
    pages/
      projects/
        projects.page.ts                    // 路徑 /projects（清單 + 建立）
        project-detail.page.ts              // 路徑 /projects/:id（任務樹/AI）
        index.ts
    components/
      projects/
        create-project-dialog.component.ts
        project-card.component.ts
        project-progress-card.component.ts
        task-item.component.ts              // 遞迴任務項
        index.ts
    pages/
      dashboard/
        project-dashboard-widgets.readme.md // 若共用，僅文檔/占位，沿用現有 dashboard

  shared/
    types/
      project/
        project.types.ts
        index.ts
    utils/
      tree/
        tree.util.ts                        // flatten/find/update 遞迴工具（如需）
    i18n/
      project/
        en-US.ts
        zh-TW.ts
```

### 路由註冊（文件變更點）
- `src/app/app.routes.ts` 新增：
```ts
{ path: 'projects', loadComponent: () => import('./interface/pages/projects/projects.page').then(m => m.ProjectsPage) },
{ path: 'projects/:id', loadComponent: () => import('./interface/pages/projects/project-detail.page').then(m => m.ProjectDetailPage) }
```

### 落地步驟（具體）
1) Domain：Project/Task 實體與 `project.repository.ts`
2) Application：
   - DTO/Validator（交叉驗證：endDate > startDate；數量/單價 > 0）
   - `project-application.service.ts`（signals：projects/loading；方法：refresh/addProject/updateTaskStatus/addTask）
   - Progress Service：抽離完成度/剩餘值/期限計算
   - UseCases：清單/建立/更新狀態/加任務
3) Infrastructure：
   - Repo 實作：先 `in-memory`，再接 `firebase/HTTP`
   - AI：`task-suggestion.service.ts` 呼叫後端 Flow
4) Interface：
   - Pages：`projects.page.ts`（清單/對話框）、`project-detail.page.ts`（任務樹/AI）
   - Components：卡片/進度卡/建立對話框/遞迴任務項；`@if/@for` + Material 3
5) Shared：共用型別、樹狀工具、i18n 文案
6) 端到端驗證：列表 → 建立 → 詳細 → 任務/AI → 驗證與例外處理


