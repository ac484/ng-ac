## 佈局結構設計（App Shell 整合版）

本文件提出一套清晰、一致且符合 DDD 的佈局結構，將「已登入主佈局」統一到 Interface Layer 的專用佈局容器中，並提供從現有結構（見 `docs/0.TREE.md`）的遷移方案。最終 `AppComponent` 維持極簡（只承載 `router-outlet`），佈局容器透過路由負責 `/app/**` 的殼層與頁面承載。

### 目標
- **清晰分層**：所有佈局組件歸屬於 Interface Layer。
- **單一主容器**：已登入區域由單一 `AppShellLayoutComponent`（或沿用/重命名 `BasicLayoutComponent`）作為主容器。
- **零業務邏輯**：佈局僅組裝與呈現，業務邏輯由 Application/Domain 提供服務。
- **可演進**：可逐步整合 App Shell 能力（主題、側欄狀態、離線指示）。

---

### 現況摘要（節選自 0.TREE）
- 根組件：`src/app/app.component.ts`（僅 `router-outlet`）
- 認證佈局：`src/app/interface/layouts/passport/passport.layout.ts`
- 已登入區域容器：目前實務上由 `src/app/shared/components/sidebar/sidebar.component.ts` 承擔（帶有 `mat-sidenav`），同時 Interface Layer 下也存在一份 `src/app/interface/components/layout/sidebar`，造成定位重疊。
- 範例佈局：`src/app/interface/layouts/basic/basic.layout.ts`

問題：側欄屬於「具體頁面佈局」而非純通用組件，應遷移/統一於 Interface Layer 的布局命名空間中，以免與 Shared Layer 的「可重用純組件」定位混淆。

---

### 目標結構（文件樹）
以下為建議的目標結構（僅列出與佈局相關重點）：

```text
src/app/
  interface/
    layouts/
      app-shell/
        app-shell.layout.ts          # AppShellLayoutComponent：已登入主容器（sidenav + header + content + router-outlet）
        index.ts
      passport/
        passport.layout.ts           # 未登入（認證）佈局
        index.ts
      blank/
        blank.layout.ts              # 空白佈局（必要時）
        index.ts

    components/
      layout/
        header/
          header.component.ts                    # src/app/interface/components/layout/header/header.component.ts
          index.ts                               # src/app/interface/components/layout/header/index.ts
        sidebar/
          sidebar.component.ts                   # src/app/interface/components/layout/sidebar/sidebar.component.ts
          sidebar.component.html                 # src/app/interface/components/layout/sidebar/sidebar.component.html（若使用模板檔）
          sidebar.component.scss                 # src/app/interface/components/layout/sidebar/sidebar.component.scss（若使用樣式檔）
          index.ts                               # src/app/interface/components/layout/sidebar/index.ts
        layout-grid/
          layout-grid.component.ts               # src/app/interface/components/layout/layout-grid/layout-grid.component.ts
          index.ts                               # src/app/interface/components/layout/layout-grid/index.ts
        app-shell/
          app-shell.component.ts                 # src/app/interface/components/layout/app-shell/app-shell.component.ts（示範用）
          app-shell.component.scss               # src/app/interface/components/layout/app-shell/app-shell.component.scss
          index.ts                               # src/app/interface/components/layout/app-shell/index.ts
        app-shell-modern/
          app-shell-modern.component.ts          # src/app/interface/components/layout/app-shell-modern/app-shell-modern.component.ts
          index.ts                               # src/app/interface/components/layout/app-shell-modern/index.ts
```

關鍵原則：
- `layouts/*` 放置「頁面級」佈局容器（直接承載 `router-outlet`）。
- `components/layout/*` 放置佈局內部可重組裝的視覺元件（如 `sidebar`、`header`）。
- Shared Layer 僅保留真正「跨上下文可重用」且與視覺語境耦合度低的通用組件與工具。

---

### 路徑遷移（from → to）
將與佈局密切相關、且目前位於 Shared Layer 的側欄遷移到 Interface Layer：

| 舊位置（from） | 新位置（to） |
|---|---|
| `src/app/shared/components/sidebar/sidebar.component.ts` | `src/app/interface/components/layout/sidebar/sidebar.component.ts` |
| `src/app/shared/components/sidebar/sidebar.component.html` | `src/app/interface/components/layout/sidebar/sidebar.component.html` |
| `src/app/shared/components/sidebar/sidebar.component.scss` | `src/app/interface/components/layout/sidebar/sidebar.component.scss` |

說明：
- 若 `interface/components/layout/sidebar` 已存在，請合併功能，保留一份定稿於 Interface Layer，並更新所有 import 路徑。
- Shared 下如僅剩 re-export，請移除或保留兼容期 re-export（短期內），最終以 Interface 為準。

---

### Shared 層盤點與決策（依 0.TREE）

佈局相關項目分類為「保留於 Shared」或「遷移至 Interface」：

| 路徑 | 決策 | 理由 |
|---|---|---|
| `src/app/shared/components/sidebar/*` | 遷移 → `src/app/interface/components/layout/sidebar/*` | 側欄屬於佈局具體視覺元件，應置於 Interface（頁面/佈局語境）。 |
| `src/app/shared/components/material/**` | 保留於 Shared | 通用 Material 封裝/示例，跨場景可複用。 |
| `src/app/shared/constants/layout/layout.constants.ts` | 保留於 Shared | 跨 UI 場景使用的布局常量（斷點等）；作為基礎設施更合適。 |
| `src/app/shared/interfaces/app-shell/*` | 保留於 Shared | App Shell 介面可能由 Application 與 Interface 共用；避免 Application 依賴 Interface。 |
| `src/app/shared/services/material/*` | 保留於 Shared | 主題/佈局/斷點等基礎設施服務，跨場景共用。 |
| `src/app/shared/utils/storage.util.ts` | 保留於 Shared | 通用工具。 |

嚴格規則：
- Shared 不得包含「承載 `router-outlet` 的頁面級佈局容器」。
- Shared 如需提供佈局相關資源，僅限「常量、類型、基礎服務、通用 UI 元件」。
- 所有頁面級佈局（含 `mat-sidenav-container` 組裝）必須在 `interface/layouts/*`。

---

### 佈局容器實作建議
可採用「重命名 Basic → AppShell」或「新建 AppShell」任一策略：

- 方案 A（重命名/升級）：
  - 將 `src/app/interface/layouts/basic/basic.layout.ts` 重命名與調整為 `src/app/interface/layouts/app-shell/app-shell.layout.ts`。
  - 內部使用 `MatSidenavContainer + Header + Sidebar + Content + router-outlet` 組裝。
- 方案 B（新建）：
  - 新增 `AppShellLayoutComponent`，將 `SidebarComponent`（已遷移至 Interface）與 `HeaderComponent` 組裝，承載 `router-outlet`。

兩者均需：
- 僅作為視覺/佈局組裝容器，完全不寫業務邏輯。
- 後續可對接 `application/services/app-shell/*`（主題、sidebar 狀態、離線/在線）以增強體驗。

---

### 路由更新（`app.routes.ts`）
將已登入區域 `/app/**` 的容器改為 `AppShellLayoutComponent`：

```ts
{
  path: 'app',
  loadComponent: () => import('./interface/layouts/app-shell').then(m => m.AppShellLayoutComponent),
  canActivate: [() => import('./security/authentication/guards').then(m => m.AuthGuard)],
  children: [
    { path: 'dashboard', loadComponent: () => import('./interface/pages/dashboard').then(m => m.DashboardPageComponent) },
    { path: 'users', loadComponent: () => import('./interface/pages/user/user-list').then(m => m.UserListPageComponent) },
    { path: 'tab-demo', loadComponent: () => import('./interface/pages/tab-demo').then(m => m.TabDemoPage) },
    { path: 'app-shell', loadComponent: () => import('./interface/pages/app-shell').then(m => m.AppShellPage) },
    { path: '', redirectTo: 'dashboard', pathMatch: 'full' }
  ]
}
```

`AppComponent` 無需改動，持續作為極簡根容器：

```html
<router-outlet />
```

---

### 實作規範（Import 與命名）
- 佈局容器命名：`AppShellLayoutComponent`、`PassportLayoutComponent`、`BlankLayoutComponent`。
- 佈局子元件命名：`HeaderComponent`、`SidebarComponent`、`LayoutGridComponent`（置於 `interface/components/layout/*`）。
- Application/Domain 如需型別或常量，優先自 `shared/**` 匯入；避免由 Application 直接依賴 Interface。

---

### 匯出規則（index.ts）
- `interface/layouts/app-shell/index.ts` 僅導出 `AppShellLayoutComponent`。
- `interface/components/layout/sidebar/index.ts` 僅導出 `SidebarComponent`。
- 禁止在 Shared 層 re-export 與佈局強關聯的組件。

---

### DDD 對齊檢核
- Interface Layer：佈局容器與佈局元件
- Application Layer：狀態/服務（`app-shell` 相關 service 仍在 Application，佈局僅訂閱使用）
- Domain Layer：不被佈局直接依賴
- Shared Layer：保持通用、低耦合

---

### 落地步驟（漸進遷移）
1. 在 `interface/layouts/app-shell/` 建立（或重命名）`AppShellLayoutComponent`。
2. 遷移/整合 `sidebar` 至 `interface/components/layout/sidebar`，移除 Shared 層的佈局側欄實作或保留短期 re-export。
3. 更新 `/app` 路由容器為 `AppShellLayoutComponent`。
4. 修正所有 `import` 指向新的 Interface 路徑。
5. 驗證 `/app/dashboard`、`/app/users`、`/app/tab-demo`、`/app/app-shell` 導覽。
6. 漸進接入 `AppShellService`（主題/離線/側欄狀態）到佈局層。

附：遷移驗收清單
- [ ] `shared/components/sidebar/*` 已移至 `interface/components/layout/sidebar/*`，且無殘留引用。
- [ ] `/app` 容器已切換為 `AppShellLayoutComponent`，導航與守衛正常。
- [ ] `shared/components/material/**` 僅作為通用組件使用，未承載頁面級佈局。
- [ ] `application/services/app-shell/**` 僅依賴 `shared/**` 型別/常量，不依賴 `interface/**`。

---

### 成果
- 佈局職責與分層語意清晰。
- 移除「Shared 與 Interface 重疊」的側欄歸屬問題。
- `AppComponent` 保持單一職責，佈局容器透過路由控制。


